var OSName="Unknown OS";if(navigator.appVersion.indexOf("Win")!=-1){OSName="Windows"}if(navigator.appVersion.indexOf("Mac")!=-1){OSName="MacOS"}if(navigator.appVersion.indexOf("X11")!=-1){OSName="UNIX"}if(navigator.appVersion.indexOf("Linux")!=-1){OSName="Linux"}if($.browser.webkit){var browser="webkit"}if($.browser.mozilla){var browser="mozilla"}if($.browser.opera){var browser="opera"}var ud=0;var viewNotes=true;var timer;var typeToScript=true;var pasting=false;var justPasted=false;var undoQue=[];var redoQue=[];var pageBreaks=[];var mouseY=0;var shiftDown=false;var mouseDownBool=false;var scrollBarBool=false;var commandDownBool=false;var characters=[];var scenes=[];var canvas;var ctx;var linesNLB=[];var vOffset=0;var pos={col:0,row:0};var anch={col:0,row:0};var background="#fff";var font="10pt Courier";var fontWidth=8;var foreground="#000";var lineheight=13;var milli=0;var formatMenu=false;var formats=["Slugline","Action","Character","Dialog","Parenthetical","Transition"];var resource_id="random123456789";var WrapVariableArray=[[62,111-10,0,1,2],[62,111-10,0,0,2],[40,271-10,0,1,1],[36,191-10,0,0,2],[30,231-10,0,0,1],[61,601-10,1,1,2]];var editorWidth=850;var headerHeight=65+26;var lines=[];notes=[];var spellWrong=[];var spellIgnore=[];var checkSpell=false;$(document).ready(function(){document.getElementById("canvas").height=$("#container").height()-60-26;document.getElementById("canvas").width=$("#container").width()-320;editorWidth=$("#container").width()-323;document.getElementById("sidebar").style.height=($("#container").height()-65)+"px";$("#container").mousewheel(function(a,c){if(a.target.id=="canvas"){a.preventDefault();scroll(-c*25)}});$("#recipient").keyup(function(a){if(a.which==188){tokenize("recipient")}});$("#collaborator").keyup(function(a){if(a.which==188){tokenize("collaborator")}});$("#renameField").keydown(function(a){if(a.which==13){a.preventDefault();renameScript()}});$("#recipient").keydown(function(a){if(a.which==13){a.preventDefault()}});$("#collaborator").keydown(function(a){if(a.which==13){a.preventDefault();shareScript()}});$("#subject").keydown(function(a){if(a.which==13){a.preventDefault()}});$(".menuItem").click(function(){openMenu(this.id)});$(".menuItem").mouseover(function(){topMenuOver(this.id)});$(".menuItem").mouseout(function(){topMenuOut(this.id)})});$(window).resize(function(){document.getElementById("canvas").height=$("#container").height()-60-26;document.getElementById("canvas").width=$("#container").width()-320;editorWidth=$("#container").width()-323;document.getElementById("sidebar").style.height=($("#container").height()-65)+"px";scroll(0);paint(false,false,false,false)});$("*").keydown(function(a){if(commandDownBool&&a.which!=16){keyboardShortcut(a)}else{var c=new Date();milli=c.getMilliseconds();if(a.which==13){enter()}else{if(a.which==38){upArrow()}else{if(a.which==40){downArrow()}else{if(a.which==39){rightArrow()}else{if(a.which==37){leftArrow()}else{if(a.which==8){backspace(a)}else{if(a.which==46){deleteButton()}else{if(a.which==9){a.preventDefault();tab()}else{if(a.which==16){shiftDown=true}else{if((OSName=="MacOS"&&(a.which==91||a.which==93)&&browser=="webkit")||(OSName=="MacOS"&&a.which==224&&browser=="mozilla")||(OSName=="MacOS"&&a.which==17&&browser=="opera")||(OSName!="MacOS"&&a.which==17)){commandDownBool=true}}}}}}}}}}if(ud<0&&typeToScript&&a.which!=13&&a.which!=46&&a.which!=8){scroll(ud-400)}if(ud>document.getElementById("canvas").height-80&&typeToScript&&a.which!=13&&a.which!=46&&a.which!=8){scroll(ud-400)}c=null}if(typeToScript){if(anch.row==pos.row&&pos.col==anch.col){document.getElementById("ccp").value=""}document.getElementById("ccp").focus();document.getElementById("ccp").select()}});$("*").keyup(function(a){if(a.which==16){shiftDown=false}else{if((OSName=="MacOS"&&(a.which==91||a.which==93)&&browser=="webkit")||(OSName=="MacOS"&&a.which==224&&browser=="mozilla")||(OSName=="MacOS"&&a.which==17&&browser=="opera")||(OSName!="MacOS"&&a.which==17)){commandDownBool=false}}if(typeToScript){document.getElementById("ccp").focus();document.getElementById("ccp").select()}});$("*").keypress(function(a){handlekeypress(a)});$("*").mousedown(function(a){if(typeToScript){mouseDown(a);document.getElementById("ccp").focus();document.getElementById("ccp").select()}});$("*").mouseup(function(a){if(typeToScript){mouseUp(a);document.getElementById("ccp").focus();document.getElementById("ccp").select()}});$("*").mousemove(function(a){mouseMove(a)});window.oncontextmenu=contextmenu;function createSuggestBox(h){if(document.getElementById("suggestBox")!=null){$(".suggestItem").unbind();document.getElementById("suggestBox").parentNode.removeChild(document.getElementById("suggestBox"))}if(h=="c"){v=characters;var e=WrapVariableArray[2][1]+Math.round((editorWidth-fontWidth*87-24)/2)+"px"}else{v=scenes;for(i in v){v[i][0]=v[i][0].split(") ").splice(1).join(") ")}var e=WrapVariableArray[0][1]+Math.round((editorWidth-fontWidth*87-24)/2)+"px"}var f=lines[pos.row][0].length;var a=lines[pos.row][0].toUpperCase();for(x in v){var o=v[x][0].substr(0,f).toUpperCase();if(a==o&&a!=v[x][0]){if(document.getElementById("suggestBox")==null){var g=document.body.appendChild(document.createElement("div"));g.id="suggestBox";g.style.position="fixed";g.style.top=ud+70+lineheight+"px";g.style.left=e}var n=false;if(h=="s"){var k=g.childNodes;for(i in k){if(v[x][0]==k[i].value){n=true}}k=null}if(!n){var m=g.appendChild(document.createElement("div"));m.className="suggestItem";m.appendChild(document.createTextNode(v[x][0]));m.value=v[x][0];document.getElementById("suggestBox").firstChild.id="focus";m=null}n=null}}if(document.getElementById("suggestBox")!=null){g=o=null}h=v=a=f=e=x=null;$(".suggestItem").mouseover(function(){document.getElementById("focus").removeAttribute("id");this.id="focus"})}function saveTimer(){document.getElementById("saveButton").disabled=false;document.getElementById("saveButton").value="Save";clearTimeout(timer);checkSpell=true;timer=setTimeout("save(1)",7000)}function ajaxSpell(a,d){checkSpell=false;var f=lines[a][0];if(lines[a][1]==0||lines[a][1]==2||lines[a][1]==5){f=f.toUpperCase()}var g=f.split(" ");for(i=0;i<g.length;i++){var e=false;for(c in spellWrong){if(g[i].toUpperCase()==spellWrong[c][0].toUpperCase()){e=true}}for(c in spellIgnore){if(g[i].toUpperCase()==spellWrong[c][0].toUpperCase()){e=true}}if(e){g.splice(i,1);i--}}i=null;var c=JSON.stringify(g);$.post("/spellcheck",{data:c,resource_id:resource_id},function(k){if(k=="correct"){return}var h=JSON.parse(k);for(i in h){spellWrong.push(h[i])}h=i=null})}function keyboardShortcut(a){if(a.which!=67&&a.which!=86&&a.which!=88){a.preventDefault();if(shiftDown&&a.which==90){redo()}else{if(a.which==90){undo()}else{if(a.which==83){save(0)}else{if(a.which==82){window.location.href=window.location.href}}}}}}function cut(){if(pos.row!=anch.row||pos.col!=anch.col){backspace()}saveTimer()}function copy(){}function paste(){if(!justPasted){saveTimer();redoQue=[];if(pos.row!=anch.row||pos.col!=anch.col){backspace()}var d=false;var h=document.getElementById("ccp").value;var g=new RegExp("\\n","g");if(h.split(g).length>1){var f=h.split(g);var c=[];for(x in f){if(f[x]!=""&&f[x]!=null){c.push([f[x],1])}}h=JSON.stringify(c);x=f=c=null}undoQue.push(["paste",pos.row,pos.col,h]);if(h[0]=="["&&h[1]=="["){d=true}if(!d){lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col)+h+lines[pos.row][0].slice(pos.col);pos.col+=document.getElementById("ccp").value.length;anch.col=pos.col}else{var a=JSON.parse(h);if(lines[pos.row][0]==""){lines[pos.row][1]=a[0][1]}if(lines[pos.row][1]==a[0][1]){undoQue[undoQue.length-1].push(1);var f=[lines[pos.row][0].slice(pos.col),lines[pos.row][1]];lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col)+a[0][0];var e=1;var k=pos.row+1;while(e<a.length){lines.splice(k,0,a[e]);k++;e++}lines.splice(k,0,f);if(lines[k][0]==""||lines[k][0]==" "){lines.splice(k,1);undoQue[undoQue.length-1].push(0)}else{undoQue[undoQue.length-1].push(1)}}else{undoQue[undoQue.length-1].push(0);var f=[lines[pos.row][0].slice(pos.col),lines[pos.row][1]];lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col);pos.row++;lines.splice(pos.row,0,a[0]);var e=1;var k=pos.row+1;while(e<a.length){lines.splice(k,0,a[e]);k++;e++}lines.splice(k,0,f);if(lines[k][0]==""||lines[k][0]==" "){lines.splice(k,1);undoQue[undoQue.length-1].push(0)}else{undoQue[undoQue.length-1].push(1)}}pos.row=anch.row=k;pos.col=anch.col=0;if(pos.row>=lines.length){pos.row=anch.row=lines.length-1;pos.col=anch.col=lines[pos.row][0].length}a=e=k=f=null}pasting=false;sceneIndex();paint(false,false,true,false);justPasted=true;setTimeout("setJustPasted()",50);d=g=h=null}}function setJustPasted(){justPasted=false}function selection(){if(pos.row>anch.row){var e={row:anch.row,col:anch.col};var a={row:pos.row,col:pos.col}}else{if(pos.row==anch.row&&pos.col>anch.col){var e={row:anch.row,col:anch.col};var a={row:pos.row,col:pos.col}}else{var e={row:pos.row,col:pos.col};var a={row:anch.row,col:anch.col}}}if(e.row==a.row){var d=lines[e.row][0].slice(e.col,a.col)}else{arr=[];arr.push([lines[e.row][0].slice(e.col),lines[e.row][1]]);e.row=e.row*1+1;while(e.row<a.row){arr.push([lines[e.row][0],lines[e.row][1]]);e.row+=1}arr.push([lines[a.row][0].slice(0,a.col),lines[a.row][1]]);var d=JSON.stringify(arr)}var f=document.getElementById("ccp");f.value=d;f.focus();f.select();e=a=d=null}function setup(){resource_id=window.location.href.split("=")[1];$.post("/scriptcontent",{resource_id:resource_id},function(k){if(k=="not found"){lines=[["Sorry, the script wasn't found.",1]];paint(false,false,true,false);return}var d=JSON.parse(k);var o=d[0];document.getElementById("title").innerHTML=o;var q=d[1];for(var l=0;l<q.length;l++){lines.push([q[l][0],q[l][1]])}if(lines.length==2){pos.row=1;anch.row=1;pos.col=lines[1][0].length;anch.col=pos.col}if(d[2].length!=0){var h=d[2][0];var m=d[2][1];for(w in h){spellWrong.push(h[w])}for(l in m){spellIgnore.push(m[l])}}for(l in d[3]){notes.push(d[3][l])}var g=d[4];var n=document.getElementById("hasAccess");for(l in g){var f=n.appendChild(document.createElement("tr"));f.id=g[l];f.appendChild(document.createElement("td")).appendChild(document.createTextNode(g[l]));var a=f.appendChild(document.createElement("td")).appendChild(document.createElement("a"));a.appendChild(document.createTextNode("Remove Access"));a.href="javascript:removeAccess('"+g[l]+"')";f=a=null}var e=document.getElementById("canvas");var r=e.getContext("2d");tabs(0);characterInit();sceneIndex();noteIndex();document.getElementById("ccp").focus();document.getElementById("ccp").select();document.getElementById("saveButton").value="Saved";document.getElementById("saveButton").disabled=true;paint(false,false,true,false);setInterval("paint(false,false, false,false)",25);l=d=k=o=q=w=n=g=null})}function tabs(a){var d=["sceneTab","noteTab"];for(i in d){var e=document.getElementById(d[i]);if(i==a){e.style.backgroundColor="#3F5EA6";e.style.color="white";document.getElementById(d[i].replace("Tab","s")).style.display="block"}else{e.style.backgroundColor="#6C8CD5";e.style.color="black";document.getElementById(d[i].replace("Tab","s")).style.display="none"}}d=i=null}function changeFormat(a){saveTimer();undoQue.push(["format",pos.row,pos.col,lines[pos.row][1],a]);redoQue=[];lines[pos.row][1]=a;anch.col=pos.col;anch.row=pos.row;if(lines[pos.row][1]==4){if(lines[pos.row][0].charAt(0)!="("){lines[pos.row][0]="("+lines[pos.row][0];pos.col++;anch.col++}if(lines[pos.row][0].charAt(lines[pos.row][0].length-1)!=")"){lines[pos.row][0]=lines[pos.row][0]+")"}}if(lines[pos.row][1]==3){if(lines[pos.row][0].charAt(0)=="("){lines[pos.row][0]=lines[pos.row][0].substr(1);pos.col--;anch.col--}if(lines[pos.row][0].charAt(lines[pos.row][0].length-1)==")"){lines[pos.row][0]=lines[pos.row][0].slice(0,-1)}}sceneIndex()}function contextmenu(c){if(c.clientX>headerHeight&&c.clientX<editorWidth-100&&c.clientY-headerHeight>40){c.preventDefault();var f=document.body.appendChild(document.createElement("div"));f.style.position="fixed";f.style.top=c.clientY-3+"px";f.style.left=c.clientX+5+"px";f.id="context_menu";for(i in formats){var a=f.appendChild(document.createElement("div"));a.innerHTML=formats[i];a.id="cm"+i;a.className="contextUnit";a=null}f=i=null;$(".contextUnit").mouseover(function(){this.style.backgroundColor="LightSkyBlue"});$(".contextUnit").mouseout(function(){this.style.backgroundColor="white"})}}function mouseUp(d){mouseDownBool=false;scrollBarBool=false;var c=document.getElementById("canvas").width;var a=document.getElementById("canvas").height;if(d.clientY-headerHeight>a-39&&d.clientY-headerHeight<a&&d.clientX>editorWidth-22&&d.clientX<editorWidth-2){if(d.clientY-headerHeight>a-20){scroll(30)}else{scroll(-30)}}c=a=null}function mouseDown(n){if(checkSpell){ajaxSpell(pos.row)}var d=false;var p=document.getElementsByTagName("div");for(var h=0;h<p.length;h++){if(p[h].className=="topMenu"&&p[h].style.display=="block"){d=true;var q=p[h]}}h=p=null;if(d){var g=n.target;while(g.nodeName!="DIV"){g=g.parentNode}id=g.id;var l=id.slice(0,-1);if(l=="format"){changeFormat(id.slice(-1))}if(id=="save"){save(0)}else{if(id=="new"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.")}else{newScriptPrompt()}}else{if(id=="open"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.")}else{openPrompt()}}else{if(id=="rename"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.")}else{renamePrompt()}}else{if(id=="exportas"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.");return}else{exportPrompt()}}else{if(id=="duplicate"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.");return}else{duplicate()}}else{if(id=="close"){closeScript()}else{if(id=="undo"){undo()}else{if(id=="redo"){redo()}else{if(id=="insertNote"){viewNotes=true;newThread()}else{if(id=="editTitlePage"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.");return}else{window.open("/titlepage?resource_id="+resource_id)}}else{if(id=="tag"){tagPrompt()}else{if(id=="spellCheck"){launchSpellCheck()}else{if(id=="revision"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.");return}else{window.open("/revisionhistory?resource_id="+resource_id)}}else{if(id=="notes"){viewNotes=(viewNotes?false:true);document.getElementById("notesViewHide").innerHTML=(viewNotes==true?"✓":"")}else{if(id=="collaborators"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.");return}else{sharePrompt()}}else{if(id=="email"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.");return}else{emailPrompt()}}}}}}}}}}}}}}}}}}q.style.display="none";q=id=l=g=null}else{if(document.getElementById("suggestBox")!=null){if(n.target.className=="suggestItem"){var m=lines[pos.row][0].length;lines[pos.row][0]=n.target.value;undoQue.push(["paste",pos.row,pos.col,lines[pos.row][0].substr(m)]);pos.col=anch.col=lines[pos.row][0].length;m=null}$(".suggestItem").unbind();document.getElementById("suggestBox").parentNode.removeChild(document.getElementById("suggestBox"))}else{if(document.getElementById("context_menu")!=null){if(n.target.className=="contextUnit"){changeFormat(n.target.id.replace("cm",""))}$(".contextUnit").unbind();document.getElementById("context_menu").parentNode.removeChild(document.getElementById("context_menu"))}else{var s=document.getElementById("canvas").height;var k=(pageBreaks.length+1)*72*lineheight;var r=((s)/k)*(s-39);if(r<20){r=20}if(r>=s-39){r=s-39}var o=(vOffset/(k-s))*(s-39-r)+headerHeight;if(n.clientX>headerHeight&&n.clientX<editorWidth-100&&n.clientY-headerHeight>40){mouseDownBool=true;mousePosition(n,"anch")}else{if(n.clientX<editorWidth&&n.clientX>editorWidth-20&&n.clientY>o&&n.clientY<o+r){scrollBarBool=true}}s=k=r=o=null}}}}function mousePosition(m,p){var n=new Date();milli=n.getMilliseconds();var k=0;var s=0;var c=m.clientY+vOffset-26;var o=15*lineheight+3;var q=0;for(i in lines){q=o;if(pageBreaks.length!=0&&pageBreaks[k]!=undefined&&pageBreaks[k][0]==i){if(pageBreaks[k][2]==0){o=72*lineheight*(k+1)+10*lineheight+headerHeight+3;k++}else{o=72*lineheight*(k+1)+10*lineheight+headerHeight+3;o+=(linesNLB[i].length-pageBreaks[k][2])*lineheight;if(lines[i][1]==3){o+=lineheight}o-=(lineheight*linesNLB[i].length);k++}}o+=(lineheight*linesNLB[i].length);if(o>c){if(pageBreaks.length!=0&&pageBreaks[k-1]!=undefined&&pageBreaks[k-1][0]==i&&pageBreaks[k-1][2]!=0){if((c-q)/lineheight<pageBreaks[k-1][2]){var f=Math.round((c-q)/lineheight+0.5)}else{if(c<72*lineheight*(k)+10*lineheight+headerHeight){var f=pageBreaks[k-1][2]}else{var f=Math.round((lineheight*linesNLB[i].length-o+c)/lineheight+0.5)}}}else{var f=Math.round((lineheight*linesNLB[i].length-o+c)/lineheight+0.5)}var h=0;var g=0;while(h+1<f){g+=linesNLB[i][h]+1;h++}var a;if(lines[i][1]!=5){a=Math.round((m.clientX-Math.round((editorWidth-fontWidth*87-24)/2)-WrapVariableArray[lines[i][1]][1])/fontWidth)}else{a=Math.round((m.clientX-Math.round((editorWidth-fontWidth*87-24)/2)-WrapVariableArray[lines[i][1]][1]+(lines[i][0].length*fontWidth))/fontWidth)}if(a<0){a=0}if(a>linesNLB[i][h]){a=linesNLB[i][h]}g+=a;if(g<0){g=0}if(g>lines[i][0].length){g=lines[i][0].length}if(p=="anch"){pos.row=anch.row=i*1;pos.col=anch.col=g*1}else{pos.row=i;pos.col=g}a=o=g=k=s=c=q=f=n=null;return}}}function mouseMove(a){if(scrollBarBool){scrollBarDrag(a)}mouseY=a.clientY;if(mouseDownBool){mousePosition(a,"pos")}}function scrollBarDrag(f){var d=mouseY-f.clientY;var a=document.getElementById("canvas").height-50;var c=(pageBreaks.length+1)*72*lineheight;vOffset-=c/a*d;if(vOffset<0){vOffset=0}var c=(pageBreaks.length+1)*72*lineheight-document.getElementById("canvas").height+20;if(vOffset>c){vOffset=c+20}d=a=c=null}function scroll(a){vOffset+=a;if(vOffset<0){vOffset=0}var c=(pageBreaks.length+1)*72*lineheight-document.getElementById("canvas").height+20;if(vOffset>c){vOffset=c+20}var e=new Date();milli=e.getMilliseconds();if(document.getElementById("suggestBox")!=null){paint(false,false,false,false);createSuggestBox((lines[pos.row][1]==0?"s":"c"))}c=e=null}function jumpTo(a){if(a!=""){var h=parseInt(a.replace("row",""));pos.row=h;anch.row=pos.row;pos.col=lines[pos.row][0].length;anch.col=pos.col}else{var h=pos.row}var d=0;for(var c=0;c<h;c++){for(var f=0;f<pageBreaks.length;f++){if(pageBreaks[f][0]==c){d=lineheight*72*(f*1+1);if(pageBreaks[f][2]!=0){d-=lineheight*(linesNLB[c].length-pageBreaks[f][2])}}}f=null;d+=(linesNLB[c].length*lineheight)}vOffset=d;var g=(pageBreaks.length+1)*72*lineheight-document.getElementById("canvas").height;if(vOffset>g){vOffset=g}h=c=d=g=null}function upArrow(){if(typeToScript&&document.getElementById("suggestBox")==null){if(pos.row==0&&pos.col==0){return}var l=lines[pos.row][1];if(l==0){var k=WrapVariableArray[0]}else{if(l==1){var k=WrapVariableArray[1]}else{if(l==2){var k=WrapVariableArray[2]}else{if(l==3){var k=WrapVariableArray[3]}else{if(l==4){var k=WrapVariableArray[4]}else{if(l==5){var k=WrapVariableArray[5]}}}}}}if(lines[pos.row][0].length>k[0]){var m=lines[pos.row][0].split(" ");var a=0;var c=[];while(a<m.length){if(m.slice(a).join().length<=k[0]){c.push(m.slice(a).join().length);a=m.length}else{var n=0;while(m.slice(a,a+n).join().length<k[0]){n++}c.push(m.slice(a,a+n-1).join().length);a+=n-1}}n=0;var h=c[0];while(h<pos.col){n++;h+=c[n]+1}if(pos.row==0&&n==0){pos.col=anch.col=0;return}if(n==0){if(checkSpell){ajaxSpell(pos.row)}var d=lines[pos.row-1][1];if(d==0){var e=WrapVariableArray[0]}else{if(d==1){var e=WrapVariableArray[1]}else{if(d==2){var e=WrapVariableArray[2]}else{if(d==3){var e=WrapVariableArray[3]}else{if(d==4){var e=WrapVariableArray[4]}else{if(d==5){var e=WrapVariableArray[5]}}}}}}if(lines[pos.row-1][0].length<e[0]){pos.row--;if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}else{var m=lines[pos.row-1][0].split(" ");var a=0;var c=[];while(a<m.length){if(m.slice(a).join().length<=k[0]){c.push(m.slice(a).join().length);a=m.length}else{var n=0;while(m.slice(a,a+n).join().length<k[0]){n++}c.push(m.slice(a,a+n-1).join().length);a+=n-1}}pos.row--;pos.col+=lines[pos.row][0].length-c[c.length-1];if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}}else{pos.col-=c[n-1]+1;if(pos.col>(h-c[n]-1)){pos.col=h-c[n]-1}}}else{if(pos.row==0){pos.col=0}else{if(checkSpell){ajaxSpell(pos.row)}var d=lines[pos.row-1][1];if(d==0){var e=WrapVariableArray[0]}else{if(d==1){var e=WrapVariableArray[1]}else{if(d==2){var e=WrapVariableArray[2]}else{if(d==3){var e=WrapVariableArray[3]}else{if(d==4){var e=WrapVariableArray[4]}else{if(d==5){var e=WrapVariableArray[5]}}}}}}if(lines[pos.row-1][0].length<e[0]){pos.row--;if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}else{var m=lines[pos.row-1][0].split(" ");var a=0;var c=[];while(a<m.length){if(m.slice(a).join().length<=k[0]){c.push(m.slice(a).join().length);a=m.length}else{var n=0;while(m.slice(a,a+n).join().length<k[0]){n++}c.push(m.slice(a,a+n-1).join().length);a+=n-1}}pos.row--;pos.col+=lines[pos.row][0].length-c[c.length-1];if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}}}if(!shiftDown){anch.col=pos.col;anch.row=pos.row}if(ud<0){paint(false,false,false,false)}}else{if(document.getElementById("suggestBox")!=null){var g=document.getElementById("focus");g.removeAttribute("id");g=g.previousSibling;if(g==null){g=document.getElementById("suggestBox").lastChild}if(g.nodeType=="#text"){g=g.previousSibling}if(g==null){g=document.getElementById("suggestBox").lastChild}g.id="focus"}}}function downArrow(){if(typeToScript&&document.getElementById("suggestBox")==null){if(pos.row==lines.length-1&&pos.col==lines[pos.row][0].length){return}var k=lines[pos.row][1];if(k==0){var h=WrapVariableArray[0]}else{if(k==1){var h=WrapVariableArray[1]}else{if(k==2){var h=WrapVariableArray[2]}else{if(k==3){var h=WrapVariableArray[3]}else{if(k==4){var h=WrapVariableArray[4]}else{if(k==5){var h=WrapVariableArray[5]}}}}}}if(lines[pos.row][0].length>h[0]){var l=lines[pos.row][0].split(" ");var a=0;var c=[];while(a<l.length){if(l.slice(a).join().length<=h[0]){c.push(l.slice(a).join().length);a=l.length}else{var m=0;while(l.slice(a,a+m).join().length<h[0]){m++}c.push(l.slice(a,a+m-1).join().length);a+=m-1}}m=0;var g=c[0];while(g<pos.col){m++;g+=c[m]+1}if(m+1==c.length){if(checkSpell){ajaxSpell(pos.row)}for(var d=0;d<c.length-1;d++){pos.col-=c[d]}pos.col--;pos.row++;if(pos.row>lines.length-1){pos.row--;pos.col=lines[pos.row][0].length}if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}else{pos.col+=c[m]+1;if(pos.col>(g+c[m+1]+1)){pos.col=g+c[m+1]+1}}}else{if(pos.row==lines.length-1){pos.col=lines[pos.row][0].length}else{pos.row++;if(pos.row>lines.length-1){pos.row=lines.length-1}if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}}if(!shiftDown){anch.col=pos.col;anch.row=pos.row}if(ud>document.getElementById("canvas").height-50){paint(false,false,false,false)}}else{if(document.getElementById("suggestBox")!=null){var e=document.getElementById("focus");e.removeAttribute("id");e=e.nextSibling;if(e==null){e=document.getElementById("suggestBox").firstChild}if(e.nodeType=="#text"){e=e.nextSibling}if(e==null){e=document.getElementById("suggestBox").firstChild}e.id="focus"}}}function leftArrow(){if(typeToScript){var d=false;if(pos.row==0&&pos.col==0){return}if(pos.col==0){if(checkSpell){ajaxSpell(pos.row)}pos.row--;pos.col=lines[pos.row][0].length;var d=true}else{pos.col=pos.col-1}if(!shiftDown){anch.col=pos.col;anch.row=pos.row}var a=document.getElementById("suggestBox");if(d&&a!=null){a.parentNode.removeChild(a)}}}function rightArrow(){if(typeToScript){var d=false;if(pos.col==lines[pos.row][0].length&&pos.row==lines.length-1){return}if(pos.col==lines[pos.row][0].length){if(checkSpell){ajaxSpell(pos.row)}pos.row++;pos.col=0;d=true}else{pos.col=pos.col+1}if(!shiftDown){anch.col=pos.col;anch.row=pos.row}var a=document.getElementById("suggestBox");if(d&&a!=null){a.parentNode.removeChild(a)}}}function backspace(h){if(typeToScript){saveTimer();redoQue=[];if(h){h.preventDefault()}var c=false;var d=false;if(lines[pos.row][1]==0){var d=true}if(pos.row==anch.row&&pos.col==anch.col){if(pos.col==0&&pos.row==0){return}else{if(lines[pos.row][1]==4&&pos.col==1){for(x in notes){if(pos.row<notes[x][0]){notes[x][0]=notes[x][0]-1}else{if(pos.row==notes[x][0]){notes[x][1]=notes[x][1]+lines[pos.row-1][0].length;notes[x][0]=notes[x][0]-1}}if(notes[x][1]<0){notes[x][1]=0}}var f=lines[pos.row][0];if(f.charAt(0)=="("){f=f.substr(1)}if(f.charAt(f.length-1)==")"){f=f.slice(0,-1)}var k=lines[pos.row-1][0].length;lines.splice(pos.row,1);pos.row--;pos.col=k;lines[pos.row][0]=lines[pos.row][0]+f;undoQue.push(["back",pos.row,pos.col,"line",4]);d=true}else{if(pos.col==0){for(x in notes){if(pos.row<notes[x][0]){notes[x][0]=notes[x][0]-1}else{if(pos.row==notes[x][0]){notes[x][1]=notes[x][1]+lines[pos.row-1][0].length;notes[x][0]=notes[x][0]-1}}if(notes[x][1]<0){notes[x][1]=0}}var a=lines[pos.row][1];var f=lines[pos.row][0];lines.splice(pos.row,1);var k=lines[pos.row-1][0].length;lines[pos.row-1][0]=lines[pos.row-1][0]+f;pos.col=k;pos.row--;undoQue.push(["back",pos.row,pos.col,"line",a]);c=true;d=true}else{undoQue.push(["back",pos.row,pos.col,lines[pos.row][0][pos.col-1]]);lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col-1)+lines[pos.row][0].slice(pos.col);pos.col--;for(x in notes){if(pos.row==notes[x][0]){if(pos.col<notes[x][1]){notes[x][1]=notes[x][1]-1}}}}}}anch.col=pos.col;anch.row=pos.row}else{c=true;var m=false;if(anch.row>pos.row){m=true}if(anch.row==pos.row&&anch.col>pos.col){m=true}if(m){var l=anch.row;anch.row=pos.row;pos.row=l;l=anch.col;anch.col=pos.col;pos.col=l}var g=0;while(pos.col!=anch.col||pos.row!=anch.row){g++;if(lines[pos.row][1]==0){d=true}if(pos.col==0){for(x in notes){if(pos.row<notes[x][0]){notes[x][0]=notes[x][0]-1}else{if(pos.row==notes[x][0]){notes[x][1]=notes[x][1]+lines[pos.row-1][0].length;notes[x][0]=notes[x][0]-1}}if(notes[x][1]<0){notes[x][1]=0}}var a=lines[pos.row][1];var f=lines[pos.row][0];lines.splice(pos.row,1);var k=lines[pos.row-1][0].length;lines[pos.row-1][0]=lines[pos.row-1][0]+f;pos.col=k;pos.row--;undoQue.push(["back",pos.row,pos.col,"line",a]);d=true}else{undoQue.push(["back",pos.row,pos.col,lines[pos.row][0][pos.col-1]]);lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col-1)+lines[pos.row][0].slice(pos.col);pos.col--;for(x in notes){if(pos.row==notes[x][0]){if(pos.col<notes[x][1]){notes[x][1]=notes[x][1]-1}}}}}undoQue.push(["br",g])}if(c==true){sceneIndex();paint(false,false,c,false)}if(d){updateOneScene(pos.row)}}}function deleteButton(){if(typeToScript){saveTimer();redoQue=[];var a=false;var f=false;if(pos.row==anch.row&&pos.col==anch.col){if(lines[pos.row][1]==0){var a=true}if(pos.col==(lines[pos.row][0].length)&&pos.row==lines.length-1){return}if(lines[pos.row][1]==4&&lines[pos.row][0]=="()"){undoQue.push(["delete",pos.row,pos.col,"line",4]);lines.splice(pos.row,1);pos.col=0;anch.col=0}else{if(pos.col==(lines[pos.row][0].length)){for(x in notes){if(pos.row+1==notes[x][0]){notes[x][1]=notes[x][1]+lines[pos.row][0].length;notes[x][0]=notes[x][0]-1}else{if(pos.row<notes[x][0]){notes[x][0]=notes[x][0]-1}}if(notes[x][1]<0){notes[x][1]=0}}undoQue.push(["delete",pos.row,pos.col,"line",lines[pos.row+1][1]]);if(lines[pos.row+1][1]==0){a=true}var c=lines[pos.row+1][0];lines.splice((pos.row+1),1);lines[pos.row][0]+=c;f=true}else{undoQue.push(["delete",pos.row,pos.col,lines[pos.row][0][pos.col]]);lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col)+lines[pos.row][0].slice(pos.col+1);for(x in notes){if(pos.row==notes[x][0]){if(pos.col<notes[x][1]){notes[x][1]=notes[x][1]-1}}}}}}else{f=true;var g=false;if(anch.row>pos.row){g=true}if(anch.row==pos.row&&anch.col>pos.col){g=true}if(g){var e=anch.row;anch.row=pos.row;pos.row=e;e=anch.col;anch.col=pos.col;pos.col=e}var h=0;while(pos.col!=anch.col||pos.row!=anch.row){h++;if(lines[pos.row][1]==0){a=true}if(pos.col==0){for(x in notes){if(pos.row+1==notes[x][0]){notes[x][1]=notes[x][1]+lines[pos.row][0].length;notes[x][0]=notes[x][0]-1}else{if(pos.row<notes[x][0]){notes[x][0]=notes[x][0]-1}}if(notes[x][1]<0){notes[x][1]=0}}undoQue.push(["delete",pos.row-1,lines[pos.row-1][0].length,"line",lines[pos.row][1]]);var c=lines[pos.row][0];lines.splice(pos.row,1);var d=lines[pos.row-1][0].length;lines[pos.row-1][0]=lines[pos.row-1][0]+c;pos.col=d;pos.row--;a=true}else{undoQue.push(["delete",pos.row,pos.col,lines[pos.row][0][pos.col-1]]);lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col-1)+lines[pos.row][0].slice(pos.col);pos.col--;for(x in notes){if(pos.row==notes[x][0]){if(pos.col<notes[x][1]){notes[x][1]=notes[x][1]-1}}}}}undoQue.push(["dr",h])}if(f==true){sceneIndex();paint(false,false,f,false)}if(a){updateOneScene(pos.row)}}}function enter(){if(typeToScript&&document.getElementById("suggestBox")==null){saveTimer();if(checkSpell){ajaxSpell(pos.row)}lines[pos.row][0]=lines[pos.row][0].replace(/\s+$/,"");for(x in notes){if(pos.row<notes[x][0]){notes[x][0]=notes[x][0]+1}if(pos.row==notes[x][0]&&pos.col<notes[x][1]){notes[x][1]=notes[x][1]-pos.col;notes[x][0]=notes[x][0]+1}}undoQue.push(["enter",pos.row,pos.col]);redoQue=[];if(lines[pos.row][1]==2){characterIndex(lines[pos.row][0])}var d=lines[pos.row][0].slice(0,pos.col);var c=lines[pos.row][0].slice(pos.col);lines[pos.row][0]=d;if(lines[pos.row][1]==0){var e=1}else{if(lines[pos.row][1]==1){var e=2}else{if(lines[pos.row][1]==2){var e=3}else{if(lines[pos.row][1]==4){var e=3}else{if(lines[pos.row][1]==3){var e=2}else{if(lines[pos.row][1]==5){var e=0}}}}}}var f=[c,e];lines.splice(pos.row+1,0,f);pos.row++;pos.col=0;anch.row=pos.row;anch.col=pos.col;paint(false,false,true,"enter");paint(false,false,false,"enter")}else{if(document.getElementById("suggestBox")!=null){saveTimer();var a=lines[pos.row][0].length;lines[pos.row][0]=document.getElementById("focus").value;undoQue.push(["paste",pos.row,pos.col,lines[pos.row][0].substr(a)]);document.getElementById("suggestBox").parentNode.removeChild(document.getElementById("suggestBox"));pos.col=anch.col=lines[pos.row][0].length}}sceneIndex()}function tab(){if(typeToScript){saveTimer();undoQue.push(["format",pos.row,pos.col,lines[pos.row][1],"tab"]);redoQue=[];var a=false;if(lines[pos.row][1]==0){var a=true}var c=lines[pos.row][1];if(c==1){lines[pos.row][1]=0;a=true}else{if(c==0){lines[pos.row][1]=2}else{if(c==2){lines[pos.row][1]=1}else{if(c==3){lines[pos.row][1]=4}else{if(c==4){lines[pos.row][1]=3}else{if(c==5){lines[pos.row][1]=0;a=true}}}}}}if(a){sceneIndex()}a=null;if(lines[pos.row][1]==4){if(lines[pos.row][0].charAt(0)!="("){lines[pos.row][0]="("+lines[pos.row][0];pos.col++;anch.col++}if(lines[pos.row][0].charAt(lines[pos.row][0].length-1)!=")"){lines[pos.row][0]=lines[pos.row][0]+")"}}if(lines[pos.row][1]==3){if(lines[pos.row][0].charAt(0)=="("){lines[pos.row][0]=lines[pos.row][0].substr(1);pos.col--;anch.col--}if(lines[pos.row][0].charAt(lines[pos.row][0].length-1)==")"){lines[pos.row][0]=lines[pos.row][0].slice(0,-1)}}}}function handlekeypress(a){if(typeToScript&&!commandDownBool){a.preventDefault();redoQue=[];var c=new Date();milli=c.getMilliseconds();c=null;if(a.which!=13&&a.which!=37&&a.which!=0&&a.which!=8){if(pos.row!=anch.row||pos.col!=anch.col){deleteButton()}undoQue.push([String.fromCharCode(a.charCode),pos.row,pos.col]);lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col)+String.fromCharCode(a.charCode)+lines[pos.row][0].slice(pos.col);pos.col++;if(lines[pos.row][1]==0){updateOneScene(pos.row)}if(lines[pos.row][1]==2){createSuggestBox("c")}if(lines[pos.row][1]==0){createSuggestBox("s")}for(x in notes){if(pos.row==notes[x][0]){if(pos.col-1<=notes[x][1]){notes[x][1]=notes[x][1]+1}}}saveTimer();anch.col=pos.col;anch.row=pos.row}document.getElementById("ccp").focus();document.getElementById("ccp").select()}}function undo(){saveTimer();if(undoQue.length==0){return}var e=false;var c=undoQue.pop();var l=[];for(x in c){l.push(c[x])}redoQue.push(l);var e=false;if(c[0]=="enter"){var g=lines[c[1]+1][0];lines.splice((c[1]+1),1);if(lines[c[1]][1]==4&&lines[c[1]][0].charAt(lines[c[1]][0].length-1)==")"){lines[c[1]][0]=lines[c[1]][0].slice(0,-1)}lines[c[1]][0]+=g;e=true}else{if(c[0]=="back"){if(c[3]=="line"){for(x in notes){if(c[1]==notes[x][0]){if(c[2]<=notes[x][1]){notes[x][0]=notes[x][0]+1;notes[x][1]=notes[x][1]-c[2]}}else{if(c[1]<notes[x][0]){notes[x][0]=notes[x][0]+1}}}var g=lines[c[1]][0].slice(0,c[2]);var f=lines[c[1]][0].slice(c[2]);if(c[4]==3&&f.charAt(f.length-1)==")"){f=f.slice(0,-1)}lines[c[1]][0]=g;var h=[f,c[4]];lines.splice(c[1]+1,0,h);c[1]=c[1]+1;c[2]=0;e=true}else{lines[c[1]][0]=lines[c[1]][0].slice(0,c[2]-1)+c[3]+lines[c[1]][0].slice(c[2]-1);if(lines[c[1]][1]==0){updateOneScene(c[1])}for(x in notes){if(c[1]==notes[x][0]){if(c[2]<=notes[x][1]){notes[x][1]=notes[x][1]+1}}}}}else{if(c[0]=="delete"){if(c[3]=="line"){var g=lines[c[1]][0].slice(0,c[2]);var f=lines[c[1]][0].slice(c[2]);if(c[4]==3&&f.charAt(f.length-1)==")"){f=f.slice(0,-1)}lines[c[1]][0]=g;var h=[f,c[4]];lines.splice(c[1]+1,0,h);e=true}else{lines[c[1]][0]=lines[c[1]][0].slice(0,c[2])+c[3]+lines[c[1]][0].slice(c[2]);if(lines[c[1]][1]==0){updateOneScene(c[1])}}}else{if(c[0]=="format"){lines[c[1]][1]=c[3];if(lines[c[1]][0].charAt(0)=="("){lines[c[1]][0]=lines[c[1]][0].substr(1)}if(lines[c[1]][0].charAt(lines[c[1]][0].length-1)==")"){lines[c[1]][0]=lines[c[1]][0].slice(0,-1)}e=true}else{if(c[0]=="br"||c[0]=="dr"){var a=c[1];for(var m=0;m<a;m++){var c=undoQue.pop();l=[];for(x in c){l.push(c[x])}redoQue.splice(redoQue.length-1,0,l);if(c[3]=="line"){var g=lines[c[1]][0].slice(0,c[2]);var f=lines[c[1]][0].slice(c[2]);if(c[4]==3&&f.charAt(f.length-1)==")"){f=f.slice(0,-1)}lines[c[1]][0]=g;var h=[f,c[4]];lines.splice(c[1]+1,0,h);c[1]=c[1]+1;c[2]=0;e=true}else{lines[c[1]][0]=lines[c[1]][0].slice(0,c[2]-1)+c[3]+lines[c[1]][0].slice(c[2]-1);if(lines[c[1]][1]==0){updateOneScene(c[1])}}}}else{if(c[0]=="paste"){if(c[3][0]!="["&&c[3][1]!="["){lines[c[1]][0]=lines[c[1]][0].slice(0,c[2])+lines[c[1]][0].slice(c[2]+c[3].length);if(lines[c[1]][1]==0){updateOneScene(c[1])}}else{e=true;var o=JSON.parse(c[3]);if(c[4]==0){lines.splice(c[1]+1,o.length);if(c[5]==1){lines[c[1]][0]=lines[c[1]][0]+lines[c[1]+1][0];lines.splice(c[1]+1,1)}}else{lines[c[1]][0]=lines[c[1]][0].slice(0,c[2]);lines.splice(c[1]+1,o.length-1);if(c[5]==1){lines[c[1]][0]=lines[c[1]][0]+lines[c[1]+1][0];lines.splice(c[1]+1,1)}}}}else{lines[c[1]][0]=lines[c[1]][0].slice(0,c[2])+lines[c[1]][0].slice(c[2]+1);if(lines[c[1]][1]==4&&lines[c[1]][0][c[2]-1]==")"){lines[c[1]][0]=lines[c[1]][0].slice(0,c[2])+lines[c[1]][0].slice(c[2]+1);c[2]=c[2]-1}if(lines[c[1]][1]==0){updateOneScene(c[1])}for(x in notes){if(c[1]==notes[x][0]){if(c[2]<notes[x][1]){notes[x][1]=notes[x][1]-1}}}}}}}}}pos.row=c[1];pos.col=c[2];anch.row=pos.row;anch.col=pos.col;if(e==true){sceneIndex();paint(false,false,true,false)}}function redo(){saveTimer();if(redoQue.length==0){return}var e=false;var d=redoQue.pop();var m=[];for(x in d){m.push(d[x])}undoQue.push(m);var e=false;if(d[0]=="enter"){var g=lines[d[1]][0].slice(0,d[2]);var f=lines[d[1]][0].slice(d[2]);lines[d[1]][0]=g;if(lines[d[1]][1]==0){var q=1}else{if(lines[d[1]][1]==1){var q=2}else{if(lines[d[1]][1]==2){var q=3}else{if(lines[d[1]][1]==4){var q=3}else{if(lines[d[1]][1]==3){var q=2}else{if(lines[d[1]][1]==5){var q=0}}}}}}var l=[f,q];lines.splice(d[1]+1,0,l);d[1]=d[1]+1;d[2]=0;e=true}else{if(d[0]=="back"){if(d[3]!="line"){lines[d[1]][0]=lines[d[1]][0].slice(0,d[2]-1)+lines[d[1]][0].slice(d[2]);d[2]=d[2]-1;if(lines[d[1]][1]==0){updateOneScene(d[1])}}else{var g=lines[d[1]+1][0];lines.splice(d[1]+1,1);lines[d[1]][0]=lines[d[1]][0]+g;e=true}}else{if(d[0]=="delete"){if(d[3]!="line"){lines[d[1]][0]=lines[d[1]][0].slice(0,d[2])+lines[d[1]][0].slice(d[2]+1);if(lines[d[1]][1]==0){updateOneScene(d[1])}}else{var g=lines[d[1]+1][0];lines.splice(d[1]+1,1);lines[d[1]][0]=lines[d[1]][0]+g}}else{if(d[0]=="format"){if(d[4]!="tab"){lines[d[1]][1]=d[4]}else{var g=d[3];if(g==0){lines[d[1]][1]=2}else{if(g==1){lines[d[1]][1]=0}else{if(g==2){lines[d[1]][1]=1}else{if(g==3){lines[d[1]][1]=4}else{if(g==4){lines[d[1]][1]=3}else{if(g==5){lines[d[1]][1]=0}}}}}}}e=true}else{if(d[0]=="br"){var c=d[1];for(var h=0;h<c;h++){var d=redoQue.pop();m=[];for(x in d){m.push(d[x])}undoQue.splice(undoQue.length-1,0,m);if(d[3]=="line"){var g=lines[d[1]+1][0];lines.splice(d[1]+1,1);lines[d[1]][0]=lines[d[1]][0]+g;e=true}else{lines[d[1]][0]=lines[d[1]][0].slice(0,d[2]-1)+lines[d[1]][0].slice(d[2]);if(lines[d[1]][1]==0){updateOneScene(d[1])}}}d[2]=d[2]-1}else{if(d[0]=="dr"){var c=d[1];for(var h=0;h<c;h++){var d=redoQue.pop();m=[];for(x in d){m.push(d[x])}undoQue.splice(undoQue.length-1,0,m);if(d[3]=="line"){var g=lines[d[1]+1][0];lines.splice(d[1]+1,1);lines[d[1]][0]=lines[d[1]][0]+g;e=true}else{lines[d[1]][0]=lines[d[1]][0].slice(0,d[2]-1)+lines[d[1]][0].slice(d[2]);if(lines[d[1]][1]==0){updateOneScene(d[1])}}}d[2]=d[2]-1}else{if(d[0]=="paste"){if(d[3][0]!="["&&d[3][1]!="["){lines[d[1]][0]=lines[d[1]][0].slice(0,d[2])+d[3]+lines[d[1]][0].slice(d[2]);if(lines[d[1]][1]==0){updateOneScene(d[1])}}else{e=true;var o=JSON.parse(d[3]);if(lines[d[1]][0]==""){lines[d[1]][1]=o[0][1]}if(lines[d[1]][1]==o[0][1]){var m=[lines[d[1]][0].slice(d[2]),lines[d[1]][1]];lines[d[1]][0]=lines[d[1]][0].slice(0,d[2])+o[0][0];var h=1;var a=d[1]+1;while(h<o.length){lines.splice(a,0,o[h]);a++;h++}lines.splice(a,0,m);if(lines[a][0]==""||lines[a][0]==" "){lines.splice(a,1)}}else{var m=[lines[d[1]][0].slice(d[2]),lines[d[1]][1]];lines[d[1]][0]=lines[d[1]][0].slice(0,d[2]);d[1]++;lines.splice(d[1],0,o[0]);var h=1;var a=d[1]+1;while(h<o.length){lines.splice(a,0,o[h]);a++;h++}lines.splice(a,0,m);if(lines[a][0]==""||lines[a][0]==" "){lines.splice(a,1)}}}}else{lines[d[1]][0]=lines[d[1]][0].slice(0,d[2])+d[0]+lines[d[1]][0].slice(d[2]);d[2]=d[2]+1;if(lines[d[1]][1]==0){updateOneScene(d[1])}}}}}}}}if(e==true){sceneIndex();paint(false,false,true,false)}}function pagination(){pageBreaks=[];i=0;var c=0;while(i<lines.length){lineCount=c;while(lineCount+linesNLB[i].length<56){lineCount+=linesNLB[i].length;i++;if(i==lines.length){return}}var a=0;c=0;if(lines[i][1]==3&&lineCount<54&&lineCount+linesNLB[i].length>57){a=55-lineCount;c=1-a;lineCount=56}else{if(lines[i][1]==3&&lineCount<54&&linesNLB[i].length>4){a=linesNLB[i].length-3;c=1-a;lineCount=55}else{if(lines[i][1]==1&&lineCount<55&&lineCount+linesNLB[i].length>57){a=55-lineCount;c=1-a;lineCount=56}else{if(lines[i][1]==1&&lineCount<55&&linesNLB[i].length>4){a=linesNLB[i].length-3;c=1-a;lineCount=55}else{while(lines[i-1][1]==0||lines[i-1][1]==2||lines[i-1][1]==4){i--;lineCount-=linesNLB[i].length}}}}}pageBreaks.push([i,lineCount,a])}}function characterInit(){for(var a=0;a<lines.length;a++){if(lines[a][1]==2){characterIndex(lines[a][0])}}}function characterIndex(c){var a=c.toUpperCase().replace(/\s+$/,"");var e=false;for(var d=0;d<characters.length;d++){if(characters[d][0]==a){characters[d][1]=characters[d][1]+1;e=true}}if(!e){characters.push([a,1])}e=a=d=null}function sceneIndex(){$(".sceneItem").unbind();scenes=[];var a=0;for(var d=0;d<lines.length;d++){if(lines[d][1]==0){a++;var f="";if(d!=lines.length-1){f=lines[d+1][0];if((lines[d+1][1]==2||lines[d+1][1]==5)&&d!=lines.length-2){f+=" "+lines[d+2][0]}}scenes.push([String(a)+") "+lines[d][0].toUpperCase(),d,f]);f=null}}var g=document.getElementById("sceneBox").childNodes;for(var d=0;d<g.length;d++){if(g[d]!=undefined){g[d].parentNode.removeChild(g[d])}d--}for(var d=0;d<scenes.length;d++){var e=document.getElementById("sceneBox").appendChild(document.createElement("p"));e.appendChild(document.createTextNode(scenes[d][0]));e.className="sceneItem";e.id="row"+scenes[d][1];e.title=scenes[d][2];e=null}g=d=a=null;$(".sceneItem").click(function(){$(this).css("background-color","#999ccc");jumpTo(this.id)});$(".sceneItem").mouseover(function(){$(this).css("background-color","#ccccff")});$(".sceneItem").mouseout(function(){$(this).css("background-color","white")})}function updateOneScene(a){try{var g=document.getElementById("row"+a);var c=g.innerHTML.split(")")[0];g.removeChild(g.firstChild);g.appendChild(document.createTextNode(c+") "+lines[a][0].toUpperCase()))}catch(f){}}function sortNotes(d,c){if(d[0]<c[0]){return -1}if(d[0]>c[0]){return 1}if(d[1]<c[1]){return -1}if(d[1]>c[1]){return 1}return 0}function sortNotesCol(d,c){if(d[1]<c[1]){return -1}if(d[1]>c[1]){return 1}return 0}function noteIndex(){notes.sort(sortNotes);var k=document.getElementById("noteBox");$(".respond, .msg").unbind();for(var g=0;g<k.childNodes.length;g++){k.removeChild(k.firstChild);g--}for(x in notes){var d=k.appendChild(document.createElement("div"));d.className="thread";var h=d.appendChild(document.createElement("table"));h.width="100%";var e=h.appendChild(document.createElement("tr"));e.appendChild(document.createElement("td"));var m=e.appendChild(document.createElement("td"));m.align="right";var a=m.appendChild(document.createElement("a"));a.style.backgroundColor="orange";a.appendChild(document.createTextNode("Delete"));a.href="javascript:deleteThread('"+notes[x][3]+"')";a.style.textDecoration="none";a.style.color="black";for(y in notes[x][2]){var l=d.appendChild(document.createElement("div"));var f=l.appendChild(document.createElement("div"));f.innerHTML=notes[x][2][y][0];var n=l.appendChild(document.createElement("div"));n.appendChild(document.createTextNode(notes[x][2][y][1].split("@")[0]));n.align="right";n.className="msgInfo";l.className="msg";l.id=notes[x][3]+"msg";l=f=n=null}var o=d.appendChild(document.createElement("div"));o.className="respond";o.appendChild(document.createTextNode("Respond"));o.id=notes[x][3];d=e=m=a=o=null}typeToScript=true;$(".respond").click(function(){newMessage(this.id)});$(".msg").click(function(){for(g in notes){if(String(notes[g][3])==String(this.id.replace("msg",""))){pos.row=anch.row=notes[g][0];pos.col=anch.col=notes[g][1]}}paint(false,false,false,false);if(ud>document.getElementById("canvas").height){scroll(ud-document.getElementById("canvas").height+200)}if(ud<0){scroll(ud-200)}});x=g=null}function newThread(){tabs(1);viewNotes=true;document.getElementById("notesViewHide").innerHTML="✓";paint(false,false,false,false);noteIndex();typeToScript=false;var k=document.getElementById("noteBox");var e=k.appendChild(document.createElement("div"));e.className="thread";id=Math.round(Math.random()*1000000000);var f=true;while(f==true){f=false;for(d in notes){if(String(notes[d][3])==String(id)){id=Math.round(Math.random()*1000000000);f=true}}}var h=e.appendChild(document.createElement("div"));h.className="respondControls";var d=h.appendChild(document.createElement("div"));d.contentEditable=true;d.id="nmi";var g=h.appendChild(document.createElement("input"));g.type="button";g.value="Save";g.id="noteSave";var a=h.appendChild(document.createElement("input"));a.type="button";a.value="Cancel";a.id="noteCancel";$("#noteSave").click(function(){submitNewThread(id)});$("#noteCancel").click(function(){noteIndex()});d.focus()}function submitNewThread(c){var f=document.getElementById("nmi").innerHTML;var e=document.getElementById("user_email").innerHTML;var h=new Date();if(f!=""){var a=[pos.row,pos.col,[[f,e,h]],c];notes.push(a);var g=[pos.row,pos.col,f,c];if(resource_id!="Demo"){$.post("/notesnewthread",{resource_id:resource_id,row:pos.row,col:pos.col,content:f,thread_id:c,fromPage:"editor"},function(k){if(k!="sent"){alert("Sorry, there was a problem sending that message. Please try again later.")}})}}noteIndex()}function newMessage(d){noteIndex();typeToScript=false;var h=document.getElementById(d);var g=h.parentNode.insertBefore(document.createElement("div"),h);g.className="respondControls";var e=g.appendChild(document.createElement("div"));e.contentEditable=true;e.id="nmi";var f=g.appendChild(document.createElement("input"));f.type="button";f.value="Save";f.id="noteSave";var a=g.appendChild(document.createElement("input"));a.type="button";a.value="Cancel";a.id="noteCancel";h.parentNode.removeChild(h);$("#noteSave").click(function(){submitMessage(d)});$("#noteCancel").click(function(){noteIndex()});e.focus()}function submitMessage(c){for(x in notes){if(notes[x][3]==c){var h=x}}var g=new Date();var f=document.getElementById("nmi").innerHTML;var e=document.getElementById("user_email").innerHTML;if(f!=""){var a=[f,e,g];notes[h][2].push(a);if(resource_id!="Demo"){$.post("/notessubmitmessage",{resource_id:resource_id,content:f,thread_id:c,fromPage:"editor"},function(k){if(k!="sent"){alert("Sorry, there was a problem sending that message. Please try again later.")}})}a=null}noteIndex();x=g=f=e=h=null}function deleteThread(a){var e=confirm("Are you sure you want to Delete this thread? This cannot be undone.");if(e==true){if(resource_id!="Demo"){$.post("/notesdeletethread",{resource_id:resource_id,thread_id:a})}for(i in notes){if(notes[i][3]==a){var d=i}}e=i=null;notes.splice(d,1);noteIndex()}}function openMenu(a){document.getElementById(a).style.backgroundColor="#6484df";document.getElementById(a).style.color="white";document.getElementById(a+"Menu").style.display="block";var e=document.getElementsByTagName("td");for(var d=0;d<e.length;d++){if(e[d].className=="formatTD"){if(e[d].id=="check"+lines[pos.row][1]){e[d].innerHTML="";e[d].appendChild(document.createTextNode("✓"))}else{e[d].innerHTML=""}}}d=null}function topMenuOver(a){var d=false;var f=document.getElementsByTagName("div");for(var e=0;e<f.length;e++){if(f[e].className=="menuItem"){f[e].style.backgroundColor="#A2BAE9";f[e].style.color="black"}if(f[e].className=="topMenu"){if(f[e].style.display=="block"){f[e].style.display="none";d=true}}}if(d){document.getElementById(a+"Menu").style.display="block"}document.getElementById(a).style.backgroundColor="#6484df";document.getElementById(a).style.color="white";var f=document.getElementsByTagName("td");for(var e=0;e<f.length;e++){if(f[e].className=="formatTD"){if(f[e].id=="check"+lines[pos.row][1]){f[e].innerHTML="";f[e].appendChild(document.createTextNode("✓"))}else{f[e].innerHTML=""}}}d=f=e=null}function topMenuOut(a){if(document.getElementById(a+"Menu").style.display=="none"){document.getElementById(a).style.backgroundColor="#A2BAE9";document.getElementById(a).style.color="black"}}function closeScript(){var a=JSON.stringify(lines);$.post("/save",{data:a,resource_id:resource_id,autosave:0},function(c){self.close()})}function newScriptPrompt(){typeToScript=false;document.getElementById("newscriptpopup").style.visibility="visible"}function hideNewScriptPrompt(){typeToScript=true;document.getElementById("newScript").value="";document.getElementById("newscriptpopup").style.visibility="hidden";document.getElementById("createScriptButton").disabled=false;document.getElementById("createScriptButton").value="Create";document.getElementById("createScriptIcon").style.visibility="hidden"}function createScript(){var a=document.getElementById("newScript").value;if(a!=""){document.getElementById("createScriptButton").disabled=true;document.getElementById("createScriptButton").value="Creating Script...";document.getElementById("createScriptIcon").style.visibility="visible";$.post("/newscript",{filename:a,fromPage:"editor"},function(c){window.open("editor?resource_id="+c);hideNewScriptPrompt()})}}function duplicate(){$.post("/duplicate",{resource_id:resource_id,fromPage:"editor"},function(a){if(a=="fail"){return}else{window.open(a)}})}function save(c){clearTimeout(timer);if(resource_id=="Demo"){if(c==0){alert("Sorry, but you'll have to login to start saving scripts!")}return}var d=JSON.stringify(lines);document.getElementById("saveButton").value="Saving...";$.post("/save",{data:d,resource_id:resource_id,autosave:c},function(e){document.getElementById("saveButton").value="Saved";document.getElementById("saveButton").disabled=true});var a=[];for(i in notes){a.push([notes[i][0],notes[i][1],notes[i][3]])}if(a.length!=0){$.post("/notesposition",{resource_id:resource_id,positions:JSON.stringify(a)},function(e){})}d=a=i=null}function openPrompt(){window.open("/scriptlist")}function renamePrompt(){typeToScript=false;document.getElementById("renameTitle").innerHTML="Rename: "+document.getElementById("title").innerHTML;document.getElementById("renameField").value=document.getElementById("title").innerHTML;document.getElementById("renamepopup").style.visibility="visible"}function hideRenamePrompt(){document.getElementById("renameField").value="";document.getElementById("renamepopup").style.visibility="hidden";typeToScript=true}function renameScript(){var a=document.getElementById("renameField").value;if(a==""){return}document.getElementById("title").innerHTML=a;$.post("/rename",{resource_id:resource_id,rename:a,fromPage:"scriptlist"});hideRenamePrompt()}function exportPrompt(){if(document.getElementById("saveButton").value=="Save"){save(0)}typeToScript=false;document.getElementById("exportpopup").style.visibility="visible"}function hideExportPrompt(){typeToScript=true;document.getElementById("exportpopup").style.visibility="hidden"}function exportScripts(){if(resource_id=="Demo"){nope();return}else{var g;var f="&title_page="+document.getElementById("et").selectedIndex;var e=document.getElementsByTagName("input");for(var h=0;h<e.length;h++){if(e[h].checked==true){if(e[h].className=="exportList"){g=e[h].name;b="/export?resource_id="+resource_id+"&export_format="+g+"&fromPage=editor"+f;window.open(b)}}}g=f=e=h=null}}function emailPrompt(){if(document.getElementById("saveButton").value=="Save"){save(0)}typeToScript=false;document.getElementById("emailpopup").style.visibility="visible"}function hideEmailPrompt(){document.getElementById("emailpopup").style.visibility="hidden";document.getElementById("recipient").value="";document.getElementById("recipients").innerHTML="";document.getElementById("message").innerHTML="";typeToScript=true}function emailComplete(a){document.getElementById("emailS").disabled=false;document.getElementById("emailS").value="Send";if(a=="sent"){alert("Email Sent");hideEmailPrompt()}else{alert("There was a problem sending your email. Please try again later.")}}function emailScript(){tokenize("recipient");var d=new Array();var h=document.getElementsByTagName("span");for(var f=0;f<h.length;f++){if(h[f].className=="mailto"){d.push(h[f].innerHTML)}}var a=d.join(",");var e=document.getElementById("subject").value;if(e==""){e="Script"}var g=document.getElementById("message").innerHTML;$.post("/emailscript",{resource_id:resource_id,recipients:a,subject:e,body_message:g,fromPage:"editor",title_page:document.getElementById("emailTitle").selectedIndex},function(c){emailComplete(c)});document.getElementById("emailS").disabled=true;document.getElementById("emailS").value="Sending...";h=d=a=e=g=null}function sharePrompt(){typeToScript=false;document.getElementById("sharepopup").style.visibility="visible"}function hideSharePrompt(){typeToScript=true;document.getElementById("sharepopup").style.visibility="hidden";document.getElementById("collaborator").value=""}function removeAccess(a){var d=confirm("Are you sure you want to remove access for this user?");if(d==true){var d=document.getElementById(a);d.style.backgroundColor="#ccc";$.post("/removeaccess",{resource_id:resource_id,removePerson:a},function(c){document.getElementById(c).parentNode.removeChild(document.getElementById(c))})}d=null}function shareScript(){tokenize("collaborator");var a=new Array();var f=document.getElementsByTagName("span");for(var d=0;d<f.length;d++){if(f[d].className=="mailto"){a.push(f[d].innerHTML)}}var e=a.join(",");$.post("/share",{resource_id:resource_id,collaborators:e,fromPage:"scriptlist"},function(h){var g=h.split(",");var m=document.getElementById("hasAccess");for(d in g){if(g[d]!=""&&g[d]!=="not sent"){var k=m.appendChild(document.createElement("tr"));k.id=g[d];k.appendChild(document.createElement("td")).appendChild(document.createTextNode(g[d]));var l=k.appendChild(document.createElement("td")).appendChild(document.createElement("a"));l.appendChild(document.createTextNode("Remove Access"));l.href="javascript:removeAccess('"+g[d]+"')"}}document.getElementById("shareS").disabled=false;document.getElementById("shareS").value="Send Invitations"});document.getElementById("shareS").disabled=true;document.getElementById("shareS").value="Sending Invites...";document.getElementById("collaborators").innerHTML=""}function tagPrompt(){save(0);var a=prompt("Leave a tag for this version:");if(a!=null&&a!=""){$.post("/revisiontag",{resource_id:resource_id,version:"latest",tag:a},function(c){if(c!="tagged"){alert("There was a problem tagging this script. Please try again later.")}})}}function launchSpellCheck(){typeToScript=false;ajaxSpell(pos.row);var a=(pos.row==0?true:false);document.getElementById("spellcheckpopup").style.visibility="visible";spellCheckCycle(a,0,0)}function spellCheckCycle(m,a,o){if(a=="finished"){alert("Spell Check Complete");hideSpellCheck();return}var s=lines[a][0].split(" ");var q=false;while(q==false){var c=s[o].replace("?","").replace(".","").replace(",","").replace("(","").replace(")","");for(i in spellWrong){if(spellWrong[i][0].toUpperCase()==c.toUpperCase()){q=[a,o,i,];for(v in spellIgnore){if(spellIgnore[v].toUpperCase()==c.toUpperCase()){q=false}}}}if(!q){o++;if(o==s.length){o=0;a++;if(a==lines.length){q="finished"}else{s=lines[a][0].split(" ")}}}}if(q=="finished"){document.getElementById("sSuggest").innerHTML="";document.getElementById("sSentance").innerHTML="";alert("Spell Check Complete");hideSpellCheck()}else{var e=lines[a][0];var f=new RegExp(c,"i");var l="<span id='sFocus' title='"+c+"' style='color:red'>"+c+"</span>";e=e.replace(f,l);if(lines[a][1]==0||lines[a][1]==2||lines[a][1]==5){document.getElementById("sSentance").innerHTML=e.toUpperCase();document.getElementById("sSentance").innerHTML=document.getElementById("sSentance").innerHTML.replace("SFOCUS","sFocus")}else{document.getElementById("sSentance").innerHTML=e}document.getElementById("sSentance").title=a;var n=spellWrong[q[2]][1];var k=document.getElementById("sSuggest");k.innerHTML="";for(i in n){var p=k.appendChild(document.createElement("div"));p.className="spellcheckitem";if(lines[a][1]==0||lines[a][1]==2||lines[a][1]==5){p.appendChild(document.createTextNode(n[i].toUpperCase()))}else{p.appendChild(document.createTextNode(n[i]))}p.title=n[i]}o++;if(o==s.length){o=0;a++;if(a==lines.length){q="finished"}else{s=lines[a][0].split(" ")}}var g=(q=="finished"?q:[a,o].join(","));document.getElementById("sHidden").value=g;$(".spellcheckitem").click(function(){var d=document.getElementById("spellcheckfocus");if(d!=undefined){d.removeAttribute("id")}this.id="spellcheckfocus";document.getElementById("sFocus").innerHTML=this.title})}}function hideSpellCheck(){document.getElementById("spellcheckpopup").style.visibility="hidden";typeToScript=true;saveTimer()}function s_ignore(){var a=document.getElementById("sHidden").value;spellCheckCycle(false,a.split(",")[0],a.split(",")[1])}function s_ignore_all(){spellIgnore.push(document.getElementById("sFocus").title);var a=document.getElementById("sHidden").value;spellCheckCycle(false,a.split(",")[0],a.split(",")[1])}function s_change(){var d=document.getElementById("sSentance");var e=d.title;lines[e][0]="";for(i in d.childNodes){if(d.childNodes[i].nodeName=="#text"){lines[e][0]=lines[e][0]+d.childNodes[i].nodeValue}else{var f=d.childNodes[i].childNodes;for(j in f){if(f[j].nodeName=="#text"){lines[e][0]=lines[e][0]+f[j].nodeValue}}}}var a=document.getElementById("sHidden").value;spellCheckCycle(false,a.split(",")[0],a.split(",")[1]);paint(false,false,true,false)}function scrollArrows(c){var a=document.getElementById("canvas").height;c.fillStyle="#333";c.fillRect(editorWidth-21,a-39,21,20);c.fillStyle="#ddd";c.fillRect(editorWidth-19,a-37,16,16);c.beginPath();c.moveTo(editorWidth-16,a-24);c.lineTo(editorWidth-10.5,a-35);c.lineTo(editorWidth-5,a-24);c.closePath();c.fillStyle="#333";c.fill();c.fillStyle="#333";c.fillRect(editorWidth-21,a-19,20,20);c.fillStyle="#ddd";c.fillRect(editorWidth-19,a-18,16,16);c.beginPath();c.moveTo(editorWidth-16,a-15);c.lineTo(editorWidth-10.5,a-4);c.lineTo(editorWidth-5,a-15);c.closePath();c.fillStyle="#333";c.fill();a=null}function scrollBar(l,g){var a=l.createLinearGradient(editorWidth-15,0,editorWidth,0);a.addColorStop(0,"#5587c4");a.addColorStop(0.8,"#95a7d4");l.strokeStyle="#333";l.fillStyle=a;var k=document.getElementById("canvas").height;var c=(pageBreaks.length+1)*72*lineheight+40;var h=((k)/c)*(k-39);if(h<20){h=20}if(h>=k-39){h=k-39}var e=(vOffset/(c-k))*(k-39-h);l.fillRect(editorWidth-18.5,e+8,16,h-17);l.strokeRect(editorWidth-18.5,e+8,16,h-17);l.beginPath();l.arc(editorWidth-10.5,e+9,8,0,Math.PI,true);l.fill();l.stroke();l.beginPath();l.arc(editorWidth-10.5,e+h-11,8,0,Math.PI,false);l.fill();l.stroke();var d=e;while(d<e+h){var f=l.createRadialGradient(editorWidth,d+10,4,editorWidth+200,d,10);f.addColorStop(0,"rgba(100,140,210,0.4)");f.addColorStop(0.4,"rgba(180,160,240,0.4)");f.addColorStop(1,"rgba(1,159,98,0)");l.fillStyle=f;l.fillRect(editorWidth-18.5,e+8,16,h-17);d+=20}l.beginPath();l.moveTo(editorWidth-7,e+9);l.lineTo(editorWidth-7,e+h-10);l.lineCap="round";l.strokeStyle="rgba(200,220,255,0.3)";l.lineWidth=4;l.stroke();l.beginPath();l.moveTo(editorWidth-9,e+10);l.lineTo(editorWidth-9,e+h-10);l.strokeStyle="rgba(200,220,255,0.1)";l.lineWidth=2;l.stroke();k=c=h=e=d=null}function drawRange(r,q){if(pos.row>anch.row){var k={row:anch.row,col:anch.col};var f={row:pos.row,col:pos.col}}else{if(pos.row==anch.row&&pos.col>anch.col){var k={row:anch.row,col:anch.col};var f={row:pos.row,col:pos.col}}else{var k={row:pos.row,col:pos.col};var f={row:anch.row,col:anch.col}}}var p=lineheight*9+3;var d=0;for(var t=0;t<k.row;t++){if(pageBreaks.length!=0&&pageBreaks[d][2]==0&&pageBreaks[d][0]-1==t){p=72*lineheight*(d+1)+9*lineheight+4;d++;if(d==pageBreaks.length){d--}}else{if(pageBreaks.length!=0&&pageBreaks[d][2]!=0&&pageBreaks[d][0]==t){p=72*lineheight*(d+1)+9*lineheight+4;p+=(linesNLB[t].length-pageBreaks[d][2])*lineheight;if(lines[t][1]==3){p+=lineheight}d++;if(d==pageBreaks.length){d--}}else{p+=lineheight*linesNLB[t].length}}}var t=0;var c=linesNLB[k.row][t]+1;while(k.col>c){p+=lineheight;if(pageBreaks.length!=0&&pageBreaks[d][0]==k.row&&pageBreaks[d][2]==t+1){p=72*lineheight*(d+1)+9*lineheight+4;if(lines[k.row][1]==3){p+=lineheight}}t++;c+=linesNLB[k.row][t]+1}c-=linesNLB[k.row][t]+1;var n=WrapVariableArray[lines[k.row][1]][1];n+=((k.col-c)*fontWidth);p+=lineheight;for(note in notes){if(notes[note][0]==k.row){if(c<notes[note][1]&&c+linesNLB[k.row][t]+1>notes[note][1]){if(notes[note][1]<k.col){n+=fontWidth}}}}var o=lineheight*9+3;d=0;for(var s=0;s<f.row;s++){if(pageBreaks.length!=0&&pageBreaks[d][2]==0&&pageBreaks[d][0]-1==s){o=72*lineheight*(d+1)+9*lineheight+4;d++;if(d==pageBreaks.length){d--}}else{if(pageBreaks.length!=0&&pageBreaks[d][2]!=0&&pageBreaks[d][0]==s){o=72*lineheight*(d+1)+9*lineheight+4;o+=(linesNLB[s].length-pageBreaks[d][2])*lineheight;if(lines[s][1]==3){o+=lineheight}d++;if(d==pageBreaks.length){d--}}else{o+=lineheight*linesNLB[s].length}}}var s=0;var e=linesNLB[f.row][s]+1;while(f.col>e){o+=lineheight;if(pageBreaks.length!=0&&pageBreaks[d][0]==f.row&&pageBreaks[d][2]==s+1){o=72*lineheight*(d+1)+9*lineheight+4;if(lines[f.row][1]==3){o+=lineheight}}s++;e+=linesNLB[f.row][s]+1}e-=linesNLB[f.row][s]+1;var l=WrapVariableArray[lines[f.row][1]][1];l+=((f.col-e)*fontWidth);o+=lineheight;for(note in notes){if(notes[note][0]==f.row){if(e<notes[note][1]&&e+linesNLB[f.row][s]+1>notes[note][1]){if(notes[note][1]<f.col){l+=fontWidth}}}}r.fillStyle="lightBlue";if(o==p){var g=n;if(lines[k.row][1]==5){g-=(lines[k.row][0].length*fontWidth)}r.fillRect(g+q,p-vOffset,l-n,12);g=null}else{var m=n;if(lines[k.row][1]==5){m-=(lines[k.row][0].length*fontWidth)}r.fillRect(m+q,p-vOffset,(c+linesNLB[k.row][t]-k.col)*fontWidth,12);while(p+lineheight<o){for(var h=0;h<pageBreaks.length;h++){if(pageBreaks.length!=0&&pageBreaks[h][0]-1==k.row&&pageBreaks[h][2]==0&&t==linesNLB[k.row].length-1){p=72*lineheight*(h+1)+9*lineheight+4}else{if(pageBreaks.length!=0&&pageBreaks[h][0]==k.row&&t==pageBreaks[h][2]-1){p=72*lineheight*(h+1)+9*lineheight+4;if(lines[k.row][1]==3){p+=lineheight}}}}h=null;t++;p+=lineheight;if(linesNLB[k.row].length<=t){k.row++;t=0}if(p!=o){var u=WrapVariableArray[lines[k.row][1]][1];if(lines[k.row][1]==5){u-=(lines[k.row][0].length*fontWidth)}r.fillRect(u+q,p-vOffset,linesNLB[k.row][t]*fontWidth,12);u=null}}var a=WrapVariableArray[lines[f.row][1]][1];if(lines[f.row][1]==5){a-=(lines[f.row][0].length*fontWidth)}r.fillRect(a+q,o-vOffset,(f.col-e)*fontWidth,12);m=a=null}k=f=p=o=n=l=t=s=d=c=e=null}function drawNote(g,a,e,c,f,h){if(lines[f][1]==5){c.fillStyle="gold";c.beginPath();c.moveTo(g-fontWidth*(lines[f][0].length-e+1)+h,a-vOffset-lineheight+3);c.lineTo(g-fontWidth*(lines[f][0].length-e+1)+h,a-vOffset-lineheight+3+lineheight);c.lineTo(g-fontWidth*(lines[f][0].length-e+1)+fontWidth+h,a-vOffset-lineheight+3+lineheight);c.lineTo(g-fontWidth*(lines[f][0].length-e+1)+fontWidth+h,a-vOffset-lineheight+3+4);c.lineTo(g-fontWidth*(lines[f][0].length-e+1)+fontWidth-4+h,a-vOffset-lineheight+3);c.closePath();c.fill();c.strokeStyle="#333";c.lineWidth=1;c.beginPath();for(var d=1;d<6;d++){c.moveTo(g-fontWidth*(lines[f][0].length-e+1)+1+h,a-vOffset-lineheight+3+(2*d)+0.5);c.lineTo(g-fontWidth*(lines[f][0].length-e+1)+fontWidth-1+h,a-vOffset-lineheight+3+(2*d)+0.5);c.stroke()}d=null;c.strokeStyle="#999";c.beginPath();c.moveTo(g-fontWidth*(lines[f][0].length-e+1)+fontWidth-4+h,a-vOffset-lineheight+3);c.lineTo(g-fontWidth*(lines[f][0].length-e+1)+fontWidth-4+h,a-vOffset-lineheight+3+4);c.lineTo(g-fontWidth*(lines[f][0].length-e+1)+fontWidth+h,a-vOffset-lineheight+3+4);c.stroke()}else{c.fillStyle="gold";c.beginPath();c.moveTo(g+fontWidth*e+h,a-vOffset-lineheight+3);c.lineTo(g+fontWidth*e+h,a-vOffset-lineheight+3+lineheight);c.lineTo(g+fontWidth*e+fontWidth+h,a-vOffset-lineheight+3+lineheight);c.lineTo(g+fontWidth*e+fontWidth+h,a-vOffset-lineheight+3+4);c.lineTo(g+fontWidth*e+fontWidth-4+h,a-vOffset-lineheight+3);c.closePath();c.fill();c.strokeStyle="#333";c.lineWidth=1;c.beginPath();for(var f=1;f<6;f++){c.moveTo(g+fontWidth*e+1+h,a-vOffset-lineheight+3+(2*f)+0.5);c.lineTo(g+fontWidth*e+fontWidth-1+h,a-vOffset-lineheight+3+(2*f)+0.5);c.stroke()}d=null;c.strokeStyle="#999";c.beginPath();c.moveTo(g+fontWidth*e+fontWidth-4+h,a-vOffset-lineheight+3);c.lineTo(g+fontWidth*e+fontWidth-4+h,a-vOffset-lineheight+3+4);c.lineTo(g+fontWidth*e+fontWidth+h,a-vOffset-lineheight+3+4);c.stroke()}c.fillStyle=foreground}function sortNumbers(d,c){return d-c}function paint(ai,F,aa,D){if(typeToScript){var q=document.getElementById("canvas");var B=q.getContext("2d");B.clearRect(0,0,2000,2500);B.fillStyle="#ccc";B.fillRect(0,0,editorWidth,document.getElementById("canvas").height);B.fillStyle=foreground;var X=Math.round((editorWidth-fontWidth*87-24)/2);var V=lineheight;B.font=font;for(var ae=0;ae<=pageBreaks.length;ae++){B.fillStyle=background;B.fillRect(X,V-vOffset,fontWidth*87,lineheight*70);B.strokeStyle="#000";B.lineWidth=1;B.strokeRect(X,V-vOffset,Math.round(fontWidth*87),lineheight*70);B.strokeStyle="#999";B.strokeRect(X-2,V-vOffset-2,Math.round(fontWidth*87)+4,lineheight*70+4);B.fillStyle=foreground;if(ae>0){B.fillText(String(ae+1)+".",550+X,V-vOffset+85)}V+=lineheight*72}V=null;if(!aa){var P=lineheight*9+2;var N=WrapVariableArray[0];B.fillStyle="#ddd";var W=0;for(var ae=0;ae<lines.length;ae++){if(pageBreaks.length!=0&&pageBreaks[W][0]==ae){P=72*lineheight*(W+1)+9*lineheight+2;if(pageBreaks[W][2]!=0){P-=pageBreaks[W][2]*lineheight;if(lines[ae][1]==3){P+=lineheight}}W++;if(W==pageBreaks.length){W--}}if(ae<linesNLB.length){for(var ac=0;ac<linesNLB[ae].length;ac++){P+=lineheight;if(lines[ae][1]==0){if(linesNLB[ae][ac]!=0){B.fillRect(N[1]-3+X,P-vOffset,61*fontWidth+6,14)}if(lines[ae][0]==""&&ac==0){B.fillRect(N[1]-3+X,P-vOffset,61*fontWidth+6,14)}}}ac=null}}P=N=W=ae=null}B.fillStyle=foreground;if(pos.row!=anch.row||anch.col!=pos.col){drawRange(B,X);if(!pasting){selection()}}B.fillStyle=foreground;B.font=font;var Q=lineheight*11;var k=[];var m="";var W=0;var t=false;var ah=0;for(var ae=0;ae<lines.length;ae++){if(lines[ae][1]==0){ah++}if(lines[ae][1]==4){if(lines[ae][0].charAt(0)!="("){lines[ae][0]="("+lines[ae][0]}if(lines[ae][0].charAt(lines[ae][0].length-1)!=")"){lines[ae][0]=lines[ae][0]+")"}}var ao=false;if(!aa){if(pageBreaks.length!=0&&pageBreaks[W]!=undefined&&pageBreaks[W][0]==ae){if(pageBreaks[W][2]==0){Q=72*lineheight*(W+1)+11*lineheight;W++;if(W>=pageBreaks.length){if(!t){t=W+1}W=pageBreaks.length-2}}else{ao=true}}}if(!aa&&!ao&&(Q-vOffset>1200||Q-vOffset<-200)){Q+=(lineheight*linesNLB[ae].length);if(ae==pos.row){var L=Q;p=[]}}else{var A=[];if(viewNotes){for(note in notes){if(notes[note][0]==ae){A.push(notes[note][1])}}}A=A.sort(sortNumbers);var ap=lines[ae][1];var l=(F?anch.row:pos.row);if(ae==pos.row){var L=Q-lineheight;if(ap==1){var M=WrapVariableArray[1][1]}else{if(ap==0){var M=WrapVariableArray[0][1]}else{if(ap==3){var M=WrapVariableArray[3][1]}else{if(ap==2){var M=WrapVariableArray[2][1]}else{if(ap==4){var M=WrapVariableArray[4][1]}else{if(ap==5){var M=WrapVariableArray[5][1]}}}}}}var E=true;var p=[]}if(ae==anch.row){var K=Q-lineheight;var O=true;var a=[]}var af=lines[ae][0];if(ap==0){var N=WrapVariableArray[0]}else{if(ap==1){var N=WrapVariableArray[1]}else{if(ap==2){var N=WrapVariableArray[2]}else{if(ap==3){var N=WrapVariableArray[3]}else{if(ap==4){var N=WrapVariableArray[4]}else{if(ap==5){var N=WrapVariableArray[5]}}}}}}var z=af.split(" ");var S=0;if(ai||F){var ab=[]}linesNLB[ae]=[];var h=0;var H=false;var c=false;while(S<z.length){var U=0;if(z.slice(S).join().length<N[0]){var al=z.slice(S).join(" ");if(lines[ae][1]==2&&m!=""&&lines[ae][0].toUpperCase()==m.toUpperCase()){al+=" (Cont'd)"}if(lines[ae][1]==0){m=""}if(N[3]==1){al=al.toUpperCase()}if(N[2]==1){B.textAlign="right"}var ak=al;var Z=[];if(viewNotes){for(note in A){if(A[note]>=lines[ae][0].length-al.length){ak=ak.substr(0,A[note]-h+Z.length)+" "+ak.substr(A[note]-h+Z.length);drawNote(N[1],Q,A[note]-h+Z.length,B,ae,X);Z.push(A[note])}}}if(al!=""){B.fillText(ak,N[1]+X,Q-vOffset)}B.textAlign="left";S=z.length;linesNLB[ae].push(al.length);Q+=lineheight;if(N[4]==2){linesNLB[ae].push(0);Q+=lineheight}if(ai||F){ab.push(al.length)}if(E){p.push(al.length)}if(O){a.push(al.length)}}else{var U=0;while(z.slice(S,S+U).join(" ").length<N[0]){newLineToPrint=z.slice(S,S+U).join(" ");U++;if(N[3]==1){newLineToPrint=newLineToPrint.toUpperCase()}}var ad=newLineToPrint;var Z=[];if(viewNotes){for(note in A){if(A[note]>=h&&A[note]<=h+newLineToPrint.length){ad=ad.substr(0,A[note]-h+Z.length)+" "+ad.substr(A[note]-h+Z.length);drawNote(N[1],Q,A[note]-h+Z.length,B,ae,X);Z.push(A[note])}}}h+=newLineToPrint.length+1;B.fillText(ad,N[1]+X,Q-vOffset);linesNLB[ae].push(newLineToPrint.length);Q+=lineheight;S+=U-1;U=0;if(ai||F){ab.push(newLineToPrint.length)}if(E){p.push(newLineToPrint.length)}if(O){a.push(newLineToPrint.length)}}if(lines[ae][1]==3&&ae+1!=lines.length&&lines[ae+1][1]==4&&linesNLB[ae][linesNLB[ae].length-1]==0){linesNLB[ae].pop();Q-=lineheight}if(ao&&linesNLB[ae].length==pageBreaks[W][2]){if(lines[ae][1]==3){B.fillText("(MORE)",WrapVariableArray[2][1]+X,Q-vOffset)}Q=72*lineheight*(W+1)+11*lineheight;if(lines[ae][1]==3){B.fillText(m.toUpperCase()+" (CONT'D)",WrapVariableArray[2][1]+X,Q-vOffset);Q+=lineheight}W++;ao=false;if(pos.row==ae){k.push(W)}}}var E=false;var O=false}if(lines[ae][1]==2){var m=lines[ae][0]}if(ae==pos.row&&t==false){t=W+1}if(ae==pos.row){var an=ah;var g=A}if(W>=pageBreaks.length){if(t==false){t=W+1}W=pageBreaks.length-2}}while(lines.length<linesNLB.length){linesNLB.pop()}var aj=new Date();var C=aj.getMilliseconds();var I=C-milli;var o=false;if(I>0&&I<500){o=true}if(I<0&&I<-500){o=true}aj=C=I=ae=null;if(p){var R=0;var u=pos.col;var s=p[R];while(pos.col>s){R++;s+=1+p[R]}s-=p[R];var T=0;for(note in g){var Y=g[note];if(Y<pos.col&&Y>s&&Y<s+p[R]){T++}Y=null}note=null;if(k.length>0&&R>=pageBreaks[k[0]-1][2]){t+=1;L=72*k[0]*lineheight+9*lineheight;if(lines[pos.row][1]==3){L+=lineheight*2;R-=pageBreaks[k[0]-1][2]}else{if(lines[pos.row][1]==1){R-=pageBreaks[k[0]-1][2];L+=lineheight}}}if(o){var J=M+((pos.col-s+T)*fontWidth)+X;if(lines[pos.row][1]==5){J-=lines[pos.row][0].length*fontWidth}ud=2+L+(R*lineheight)-vOffset;try{B.fillRect(J,ud,2,17)}catch(ag){}J=null}R=u=s=null}B.lineWidth=4;B.strokeStyle="#ddd";B.beginPath();B.moveTo(2,2);B.lineTo(2,document.getElementById("canvas").height-1);B.lineTo(editorWidth,document.getElementById("canvas").height-1);B.lineTo(editorWidth,2);B.stroke();B.fillStyle="#ccc";B.fillRect(2,document.getElementById("canvas").height-24,editorWidth-25,24);B.strokeStyle="#aaa";B.lineWidth=1;B.beginPath();B.moveTo(1.5,document.getElementById("canvas").height-25.5);B.lineTo(1.5,document.getElementById("canvas").height-1.5);B.lineTo(editorWidth-23.5,document.getElementById("canvas").height-1.5);B.lineTo(editorWidth-23.5,document.getElementById("canvas").height-25.5);B.closePath();B.strokeStyle="#999";B.stroke();B.beginPath();B.moveTo(0.5,document.getElementById("canvas").height-24.5);B.lineTo(0.5,document.getElementById("canvas").height-0.5);B.lineTo(editorWidth-22.5,document.getElementById("canvas").height-0.5);B.lineTo(editorWidth-22.5,document.getElementById("canvas").height-24.5);B.closePath();B.strokeStyle="#333";B.stroke();var am=pageBreaks.length+1;var f="Page "+t+" of "+am;B.font="10pt sans-serif";B.fillStyle="#000";B.fillText(f,editorWidth-150,document.getElementById("canvas").height-8);var G=["Enter : Action  --  Tab : Character","Enter : Character  --  Tab : Slugline","Enter : Dialog  --  Tab : Action","Enter : Character  --  Tab : Parenthetical","Enter : Dialog  --  Tab : Dialog","Enter : Slugline  --  Tab : Slugline"];B.fillText(G[lines[pos.row][1]],15,document.getElementById("canvas").height-8);var r="Scene "+an+" of "+scenes.length;B.fillText(r,(editorWidth/2)-30,document.getElementById("canvas").height-8);B.font=font;r=G=f=am=null;scrollArrows(B);scrollBar(B,Q);if(F){pos.row=anch.row;pos.col=anch.col}if(aa){pagination()}if(mouseDownBool&&pos.row<anch.row&&mouseY<40){scroll(-20)}if(mouseDownBool&&pos.row>anch.row&&mouseY>document.getElementById("canvas").height-50){scroll(20)}if(D=="enter"){if(ud>document.getElementById("canvas").height){scroll(600)}}else{if(D){if((2+L+(R*lineheight)-vOffset)>document.getElementById("canvas").height-60){scroll(45)}else{if(ud<45){scroll(-45)}}}}document.getElementById("format").selectedIndex=lines[pos.row][1]}};