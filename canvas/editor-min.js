var shiftDown=false;var characters=[];var scenes=[];var canvas;var ctx;var linesNLB=[];var vOffset=0;var pos={col:0,row:0};var anch={col:0,row:0};var background="#fff";var font="11pt Courier";var foreground="#000";var lineheight=15;var milli=0;var formatMenu=false;var formats=["Slugline","Action","Character","Dialog","Parenthetical","Transition"];var WrapVariableArray=[[61,31,0,1,2],[61,31,0,0,2],[40,212,0,1,1],[36,121,0,0,2],[30,167,0,0,1],[61,570,1,1,2]];var fontWidth=9;if($.browser.mozilla){fontWidth=8}function setup(){var b=document.getElementById("canvas");var a=b.getContext("2d");document.onkeypress=handlekeypress;characterInit();sceneIndex();paint(false,false,true);setInterval("paint(false,false, false)",40)}function mouseUp(i){var h=document.getElementById("canvas").width;var f=document.getElementById("canvas").height;if(!formatMenu){if(i.clientX>10&&i.clientX<100&&i.clientY<30&&i.clientY>10){formatMenu=true}else{if(i.clientY>f-39&&i.clientY<f&&i.clientX>598&&i.clientX<618){if(i.clientY>f-20){scroll(30)}else{scroll(-30)}}else{paint(i,false,false);anch.col=pos.col;anch.row=pos.row}}}else{if(i.clientX>10&&i.clientX<110&&i.clientY<150&&i.clientY>10){var g=i.clientY;var d=25;var j=19;if(g<d){lines[pos.row][1]="s"}else{if(g<(d+j)){lines[pos.row][1]="a"}else{if(g<(d+2*j)){lines[pos.row][1]="c"}else{if(g<(d+3*j)){lines[pos.row][1]="d"}else{if(g<(d+4*j)){lines[pos.row][1]="p"}else{lines[pos.row][1]="t"}}}}}}formatMenu=false}if(i.clientX>200&&i.clientX<310&&i.clientY<27&&i.clientY>7){lines=fivePages;paint(false,false,true)}}function mouseDown(a){paint(false,a,false)}function scroll(a){vOffset+=a;if(vOffset<0){vOffset=0}}function upArrow(){if(pos.row==0&&pos.col==0){return}var g=lines[pos.row][1];if(g=="s"){var f=WrapVariableArray[0]}else{if(g=="a"){var f=WrapVariableArray[1]}else{if(g=="c"){var f=WrapVariableArray[2]}else{if(g=="d"){var f=WrapVariableArray[3]}else{if(g=="p"){var f=WrapVariableArray[4]}else{if(g=="t"){var f=WrapVariableArray[5]}}}}}}if(lines[pos.row][0].length>f[0]){var h=lines[pos.row][0].split(" ");var a=0;var b=[];while(a<h.length){if(h.slice(a).join().length<=f[0]){b.push(h.slice(a).join().length);a=h.length}else{var i=0;while(h.slice(a,a+i).join().length<f[0]){i++}b.push(h.slice(a,a+i-1).join().length);a+=i-1}}i=0;var e=b[0];while(e<pos.col){i++;e+=b[i]+1}if(i==0){var c=lines[pos.row-1][1];if(c=="s"){var d=WrapVariableArray[0]}else{if(c=="a"){var d=WrapVariableArray[1]}else{if(c=="c"){var d=WrapVariableArray[2]}else{if(c=="d"){var d=WrapVariableArray[3]}else{if(c=="p"){var d=WrapVariableArray[4]}else{if(c=="t"){var d=WrapVariableArray[5]}}}}}}if(lines[pos.row-1][0].length<d[0]){pos.row--;if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}else{var h=lines[pos.row-1][0].split(" ");var a=0;var b=[];while(a<h.length){if(h.slice(a).join().length<=f[0]){b.push(h.slice(a).join().length);a=h.length}else{var i=0;while(h.slice(a,a+i).join().length<f[0]){i++}b.push(h.slice(a,a+i-1).join().length);a+=i-1}}pos.row--;pos.col+=lines[pos.row][0].length-b[b.length-1];if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}}else{pos.col-=b[i-1]+1;if(pos.col>(e-b[i]-1)){pos.col=e-b[i]-1}}}else{if(pos.row==0){pos.col=0}else{var c=lines[pos.row-1][1];if(c=="s"){var d=WrapVariableArray[0]}else{if(c=="a"){var d=WrapVariableArray[1]}else{if(c=="c"){var d=WrapVariableArray[2]}else{if(c=="d"){var d=WrapVariableArray[3]}else{if(c=="p"){var d=WrapVariableArray[4]}else{if(c=="t"){var d=WrapVariableArray[5]}}}}}}if(lines[pos.row-1][0].length<d[0]){pos.row--;if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}else{var h=lines[pos.row-1][0].split(" ");var a=0;var b=[];while(a<h.length){if(h.slice(a).join().length<=f[0]){b.push(h.slice(a).join().length);a=h.length}else{var i=0;while(h.slice(a,a+i).join().length<f[0]){i++}b.push(h.slice(a,a+i-1).join().length);a+=i-1}}pos.row--;pos.col+=lines[pos.row][0].length-b[b.length-1];if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}}}if(!shiftDown){anch.col=pos.col;anch.row=pos.row}}function downArrow(){if(pos.row==lines.length-1&&pos.col==lines[pos.row][0].length){return}var d=lines[pos.row][1];if(d=="s"){var c=WrapVariableArray[0]}else{if(d=="a"){var c=WrapVariableArray[1]}else{if(d=="c"){var c=WrapVariableArray[2]}else{if(d=="d"){var c=WrapVariableArray[3]}else{if(d=="p"){var c=WrapVariableArray[4]}else{if(d=="t"){var c=WrapVariableArray[5]}}}}}}if(lines[pos.row][0].length>c[0]){var b=lines[pos.row][0].split(" ");var f=0;var g=[];while(f<b.length){if(b.slice(f).join().length<=c[0]){g.push(b.slice(f).join().length);f=b.length}else{var a=0;while(b.slice(f,f+a).join().length<c[0]){a++}g.push(b.slice(f,f+a-1).join().length);f+=a-1}}a=0;var h=g[0];while(h<pos.col){a++;h+=g[a]+1}if(a+1==g.length){for(var e=0;e<g.length-1;e++){pos.col-=g[e]}pos.col--;pos.row++;if(pos.row>lines.length-1){pos.row--;pos.col=lines[pos.row][0].length}if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}else{pos.col+=g[a]+1;if(pos.col>(h+g[a+1]+1)){pos.col=h+g[a+1]+1}}}else{if(pos.row==lines.length-1){pos.col=lines[pos.row][0].length}else{pos.row++;if(pos.row>lines.length-1){pos.row=lines.length-1}if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}}if(!shiftDown){anch.col=pos.col;anch.row=pos.row}}function leftArrow(){if(pos.row==0&&pos.col==0){return}if(pos.col==0){pos.row--;pos.col=lines[pos.row][0].length}else{pos.col=pos.col-1}if(!shiftDown){anch.col=pos.col;anch.row=pos.row}}function rightArrow(){if(pos.col==lines[pos.row][0].length&&pos.row==lines.length-1){return}if(pos.col==lines[pos.row][0].length){pos.row++;pos.col=0}else{pos.col=pos.col+1}if(!shiftDown){anch.col=pos.col;anch.row=pos.row}}function backspace(g){g.preventDefault();var a=false;if(lines[pos.row][1]=="s"){var a=true}if(pos.row==anch.row&&pos.col==anch.col){if(pos.col==0&&pos.row==0){return}if(pos.col==0){var b=lines[pos.row][0];lines.splice(pos.row,1);var d=lines[pos.row-1][0].length;lines[pos.row-1][0]=lines[pos.row-1][0]+b;pos.col=d;pos.row--}else{lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col-1)+lines[pos.row][0].slice(pos.col);pos.col--}anch.col=pos.col;anch.row=pos.row}else{var f=false;if(anch.row>pos.row){f=true}if(anch.row==pos.row&&anch.col>pos.col){f=true}if(f){var c=anch.row;anch.row=pos.row;pos.row=c;c=anch.col;anch.col=pos.col;pos.col=c}while(pos.col!=anch.col||pos.row!=anch.row){if(lines[pos.row][1]=="s"){a=true}if(pos.col==0){var b=lines[pos.row][0];lines.splice(pos.row,1);var d=lines[pos.row-1][0].length;lines[pos.row-1][0]=lines[pos.row-1][0]+b;pos.col=d;pos.row--}else{lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col-1)+lines[pos.row][0].slice(pos.col);pos.col--}}}if(a){sceneIndex()}}function deleteButton(){var a=false;if(pos.row==anch.row&&pos.col==anch.col){if(lines[pos.row][1]=="s"){var a=true}if(pos.col==(lines[pos.row][0].length)&&pos.row==lines.length-1){return}if(pos.col==(lines[pos.row][0].length)){if(lines[pos.row+1][1]=="s"){a=true}var b=lines[pos.row+1][0];lines.splice((pos.row+1),1);lines[pos.row][0]+=b}else{lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col)+lines[pos.row][0].slice(pos.col+1)}}else{var e=false;if(anch.row>pos.row){e=true}if(anch.row==pos.row&&anch.col>pos.col){e=true}if(e){var d=anch.row;anch.row=pos.row;pos.row=d;d=anch.col;anch.col=pos.col;pos.col=d}while(pos.col!=anch.col||pos.row!=anch.row){if(lines[pos.row][1]=="s"){a=true}if(pos.col==0){var b=lines[pos.row][0];lines.splice(pos.row,1);var c=lines[pos.row-1][0].length;lines[pos.row-1][0]=lines[pos.row-1][0]+b;pos.col=c;pos.row--}else{lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col-1)+lines[pos.row][0].slice(pos.col);pos.col--}}}if(a){sceneIndex()}}function enter(){if(lines[pos.row][1]=="c"){characterIndex(lines[pos.row][0])}var b=lines[pos.row][0].slice(0,pos.col);var a=lines[pos.row][0].slice(pos.col);lines[pos.row][0]=b;if(lines[pos.row][1]=="s"){var c="a"}else{if(lines[pos.row][1]=="a"){var c="c"}else{if(lines[pos.row][1]=="c"){var c="d"}else{if(lines[pos.row][1]=="p"){var c="d"}else{if(lines[pos.row][1]=="d"){var c="c"}else{if(lines[pos.row][1]=="t"){var c="s"}}}}}}var d=[a,c];lines.splice(pos.row+1,0,d);pos.row++;pos.col=0;paint(false,false,true);if(lines[pos.row][1]=="a"){sceneIndex()}}function tab(){var a=false;if(lines[pos.row][1]=="s"){var a=true}var b=lines[pos.row][1];if(b=="a"){lines[pos.row][1]="s";a=true}else{if(b=="s"){lines[pos.row][1]="c"}else{if(b=="c"){lines[pos.row][1]="a"}else{if(b=="d"){lines[pos.row][1]="p"}else{if(b=="p"){lines[pos.row][1]="d"}else{if(b=="t"){lines[pos.row][1]="s";a=true}}}}}}if(a){sceneIndex()}}function handlekeypress(a){var b=new Date();milli=b.getMilliseconds();if(a.which!=13){lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col)+String.fromCharCode(a.charCode)+lines[pos.row][0].slice(pos.col);pos.col++;if(lines[pos.row][1]=="s"){sceneIndex()}}anch.col=pos.col;anch.row=pos.row}function characterInit(){for(var a=0;a<lines.length;a++){if(lines[a][1]=="c"){characterIndex(lines[a][0])}}}function characterIndex(b){var a=b.toUpperCase();var d=false;for(var c=0;c<characters.length;c++){if(characters[c][0]==a){characters[c][1]=characters[c][1]+1;d=true}}if(!d){characters.push([a,1])}}function sceneIndex(){scenes=[];var a=0;for(var b=0;b<lines.length;b++){if(lines[b][1]=="s"){a++;scenes.push(String(a)+") "+lines[b][0].toUpperCase())}}}function scrollArrows(b){var a=document.getElementById("canvas").height;b.fillStyle="#333";b.fillRect(598,a-39,20,20);b.fillStyle="#ddd";b.fillRect(600,a-37,16,16);b.beginPath();b.moveTo(602,a-24);b.lineTo(608,a-35);b.lineTo(614,a-24);b.closePath();b.fillStyle="#333";b.fill();b.fillStyle="#333";b.fillRect(598,a-19,20,20);b.fillStyle="#ddd";b.fillRect(600,a-18,16,16);b.beginPath();b.moveTo(602,a-15);b.lineTo(608,a-4);b.lineTo(614,a-15);b.closePath();b.fillStyle="#333";b.fill()}function scrollBar(b,e){var a=document.getElementById("canvas").height;var d=((a-35)/e)*(a-35-39);if(d<30){d=30}if(d>=a-35-39){d=a-35-39}var c=(vOffset/(e-a))*(a-35-39-d)+35;b.fillRect(598,c,20,d)}function paint(G,K,H){var c=document.getElementById("canvas");var z=c.getContext("2d");z.clearRect(0,0,2000,2500);z.fillStyle=background;z.fillRect(0,0,800,570);z.fillStyle=foreground;z.lineWidth=4;z.strokeStyle="#ddd";z.beginPath();z.moveTo(2,2);z.lineTo(2,document.getElementById("canvas").height-1);z.lineTo(620,document.getElementById("canvas").height-1);z.lineTo(620,2);z.stroke();z.font=font;var q=lineheight+50;for(var C=0;C<lines.length;C++){if(!H&&(q-vOffset>1200||q-vOffset<0)){q+=(lineheight*linesNLB[C])}else{var g=lines[C][1];if(C==pos.row){var j=q-lineheight;if(g=="a"){var l=31}else{if(g=="s"){var l=31}else{if(g=="d"){var l=121}else{if(g=="c"){var l=212}else{if(g=="p"){var l=167}else{if(g=="t"){var l=570}}}}}}var B=true;var a=[]}var o=lines[C][0];if(g=="s"){var m=WrapVariableArray[0];var w=(Math.round((o.length/61)+0.5))*16;z.fillStyle="#ddd";z.fillRect(m[1]-3,(q-12-vOffset),540,w);z.fillStyle=foreground}else{if(g=="a"){var m=WrapVariableArray[1]}else{if(g=="c"){var m=WrapVariableArray[2]}else{if(g=="d"){var m=WrapVariableArray[3]}else{if(g=="p"){var m=WrapVariableArray[4]}else{if(g=="t"){var m=WrapVariableArray[5]}}}}}}var p=o.split(" ");var E=0;if(G){var k=[]}linesNLB[C]=0;while(E<p.length){var b=0;if(p.slice(E).join().length<m[0]){var u=p.slice(E).join(" ");if(m[3]==1){u=u.toUpperCase()}if(m[2]==1){z.textAlign="right"}if(u!=""){z.fillText(u,m[1],q-vOffset)}z.textAlign="left";E=p.length;for(var J=0;J<m[4];J++){linesNLB[C]=linesNLB[C]+1;q+=lineheight}if(G){k.push(u.length)}if(B){a.push(u.length)}}else{var b=0;while(p.slice(E,E+b).join(" ").length<m[0]){newLineToPrint=p.slice(E,E+b).join(" ");b++;if(m[3]==1){newLineToPrint=newLineToPrint.toUpperCase()}}z.fillText(newLineToPrint,m[1],q-vOffset);linesNLB[C]=linesNLB[C]+1;q+=lineheight;E+=b-1;b=0;var J=1;if(G){k.push(newLineToPrint.length)}if(B){a.push(newLineToPrint.length)}}if(G&&G.clientY+vOffset>(q-6-18*J)&&G.clientY+vOffset<(q+19-18*J)){pos.row=C;pos.col=0;for(var t=0;t<k.length-1;t++){pos.col+=k[t]+1}if(g!="t"){pos.col+=Math.round(((G.clientX-m[1])/fontWidth))}else{pos.col-=Math.round(((m[1]-G.clientX)/fontWidth));pos.col+=lines[C][0].length}var A=0;for(var t=0;t<k.length;t++){A+=k[t]+1}if(pos.col>A){pos.col=A-1}if(pos.col<0){pos.col=0}}}var B=false}}var I=new Date();var M=I.getMilliseconds();var s=M-milli;var h=false;if(s>0&&s<500){h=true}if(s<0&&s<-500){h=true}if(h&&a){var r=0;lrPosDiff=pos.col;var L=a[r];while(pos.col>L){r++;L+=1+a[r]}L-=a[r];var n=l+((pos.col-L)*fontWidth);if(lines[pos.row][1]=="t"){n-=lines[pos.row][0].length*fontWidth}var x=2+j+(r*lineheight)-vOffset;z.fillRect(n,x,1,20)}var v=50;for(var C=0;C<scenes.length;C++){z.fillText(scenes[C],640,v);v+=lineheight}z.fillStyle="#6484df";z.fillRect(0,0,document.getElementById("canvas").width,35);z.fillStyle="#efefef";z.fillRect(10,7,110,20);z.fillStyle=foreground;z.font="12pt Arial";var F=lines[pos.row][1];if(F=="s"){var D="Slugline"}else{if(F=="a"){var D="Action"}else{if(F=="c"){var D="Character"}else{if(F=="d"){var D="Dialog"}else{if(F=="p"){var D="Parenthetical"}else{if(F=="t"){var D="Transition"}}}}}}z.fillText(D,15,23);z.font=font;z.fillStyle=foreground;z.fillRect(200,7,110,20);if(formatMenu){z.fillStyle="#efefef";z.fillRect(10,7,110,120);z.fillStyle=foreground;z.font="12pt Arial";formatMenuY=23;for(var C=0;C<formats.length;C++){z.fillText(formats[C],15,formatMenuY);formatMenuY+=19}}scrollArrows(z);scrollBar(z,q)};