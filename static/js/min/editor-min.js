var OSName="Unknown OS";if(navigator.appVersion.indexOf("Win")!=-1){OSName="Windows"}if(navigator.appVersion.indexOf("Mac")!=-1){OSName="MacOS"}if(navigator.appVersion.indexOf("X11")!=-1){OSName="UNIX"}if(navigator.appVersion.indexOf("Linux")!=-1){OSName="Linux"}if($.browser.webkit){var browser="webkit"}if($.browser.mozilla){var browser="mozilla"}if($.browser.opera){var browser="opera"}var ud=0;var viewNotes=true;var timer;var typeToScript=true;var pasting=false;var undoQue=[];var redoQue=[];var pageBreaks=[];var mouseX=0;var mouseY=0;var shiftDown=false;var mouseDownBool=false;var scrollBarBool=false;var commandDownBool=false;var characters=[];var scenes=[];var canvas;var ctx;var linesNLB=[];var vOffset=0;var pos={col:0,row:0};var anch={col:0,row:0};var background="#fff";var font="10pt Courier";var fontWidth=8;var foreground="#000";var lineheight=13;var milli=0;var formatMenu=false;var formats=["Slugline","Action","Character","Dialog","Parenthetical","Transition"];var resource_id="random123456789";var WrapVariableArray=[[62,111+50,0,1,2],[62,111+50,0,0,2],[40,271+50,0,1,1],[36,191+50,0,0,2],[30,231+50,0,0,1],[61,601+50,1,1,2]];var editorWidth=850;var headerHeight=65;var lines=[];notes=[];var spellWrong=[];var spellIgnore=[];var checkSpell=false;$(document).ready(function(){document.getElementById("canvas").height=$("#container").height()-60;document.getElementById("sidebar").style.height=($("#container").height()-65)+"px";document.getElementById("sidebar").style.width=($("#container").width()-853)+"px";$("#container").mousewheel(function(a,b){if(a.target.id=="canvas"){a.preventDefault();scroll(-b*45)}});$("#recipient").keyup(function(a){if(a.which==188){tokenize("recipient")}});$("#collaborator").keyup(function(a){if(a.which==188){tokenize("collaborator")}});$("#renameField").keydown(function(a){if(a.which==13){a.preventDefault();renameScript()}});$("#recipient").keydown(function(a){if(a.which==13){a.preventDefault()}});$("#collaborator").keydown(function(a){if(a.which==13){a.preventDefault();shareScript()}});$("#subject").keydown(function(a){if(a.which==13){a.preventDefault()}});$(".menuItem").click(function(){openMenu(this.id)});$(".menuItem").mouseover(function(){topMenuOver(this.id)});$(".menuItem").mouseout(function(){topMenuOut(this.id)})});$(window).resize(function(){document.getElementById("canvas").height=$("#container").height()-60;document.getElementById("sidebar").style.height=($("#container").height()-65)+"px";document.getElementById("sidebar").style.width=($("#container").width()-853)+"px"});$("*").keydown(function(a){if(commandDownBool&&a.which!=16){keyboardShortcut(a)}else{var b=new Date();milli=b.getMilliseconds();if(a.which==13){enter()}else{if(a.which==38){upArrow()}else{if(a.which==40){downArrow()}else{if(a.which==39){rightArrow()}else{if(a.which==37){leftArrow()}else{if(a.which==8){backspace(a)}else{if(a.which==46){deleteButton()}else{if(a.which==9){a.preventDefault();tab()}else{if(a.which==16){shiftDown=true}else{if((OSName=="MacOS"&&(a.which==91||a.which==93)&&browser=="webkit")||(OSName=="MacOS"&&a.which==224&&browser=="mozilla")||(OSName=="MacOS"&&a.which==17&&browser=="opera")||(OSName!="MacOS"&&a.which==17)){commandDownBool=true}}}}}}}}}}if((ud<0||ud>document.getElementById("canvas").height-80)&&typeToScript&&a.which!=13&&a.which!=46&&a.which!=8){scroll(ud-400)}}if(typeToScript){document.getElementById("ccp").focus();document.getElementById("ccp").select()}});$("*").keyup(function(a){if(a.which==16){shiftDown=false}else{if((OSName=="MacOS"&&(a.which==91||a.which==93)&&browser=="webkit")||(OSName=="MacOS"&&a.which==224&&browser=="mozilla")||(OSName=="MacOS"&&a.which==17&&browser=="opera")||(OSName!="MacOS"&&a.which==17)){commandDownBool=false}}if(typeToScript){document.getElementById("ccp").focus();document.getElementById("ccp").select()}});$("*").keypress(function(a){handlekeypress(a)});$("*").mousedown(function(a){if(typeToScript){mouseDown(a);document.getElementById("ccp").focus();document.getElementById("ccp").select()}});$("*").mouseup(function(a){if(typeToScript){mouseUp(a);document.getElementById("ccp").focus();document.getElementById("ccp").select()}});$("*").mousemove(function(a){mouseMove(a)});function createSuggestBox(g){if(document.getElementById("suggestBox")!=null){document.getElementById("suggestBox").parentNode.removeChild(document.getElementById("suggestBox"))}if(g=="c"){v=characters;var b=WrapVariableArray[2][1]+"px"}else{v=scenes;for(i in v){v[i][0]=v[i][0].split(") ").splice(1).join(") ")}var b=WrapVariableArray[0][1]+"px"}var e=lines[pos.row][0].length;for(x in v){var a=lines[pos.row][0].toUpperCase();var n=v[x][0].substr(0,e).toUpperCase();if(a==n&&a!=v[x][0]){if(document.getElementById("suggestBox")==null){var f=document.body.appendChild(document.createElement("div"));f.id="suggestBox";f.style.position="fixed";f.style.top=ud+70+lineheight+"px";f.style.left=b}var m=false;if(g=="s"){var h=f.childNodes;for(i in h){if(v[x][0]==h[i].value){m=true}}}if(!m){var k=f.appendChild(document.createElement("div"));k.className="suggestItem";k.appendChild(document.createTextNode(v[x][0]));k.value=v[x][0];document.getElementById("suggestBox").firstChild.id="focus"}}}$(".suggestItem").mouseover(function(){document.getElementById("focus").removeAttribute("id");this.id="focus"})}function saveTimer(){document.getElementById("saveButton").disabled=false;document.getElementById("saveButton").value="Save";clearTimeout(timer);checkSpell=true;timer=setTimeout("save(1)",7000)}function ajaxSpell(a,c){checkSpell=false;var e=lines[a][0];if(lines[a][1]==0||lines[a][1]==2||lines[a][1]==5){e=e.toUpperCase()}var f=e.split(" ");for(i=0;i<f.length;i++){var d=false;for(b in spellWrong){if(f[i].toUpperCase()==spellWrong[b][0].toUpperCase()){d=true}}for(b in spellIgnore){if(f[i].toUpperCase()==spellWrong[b][0].toUpperCase()){d=true}}if(d){f.splice(i,1);i--}}var b=JSON.stringify(f);$.post("/spellcheck",{data:b,resource_id:resource_id},function(h){if(h=="correct"){return}var g=JSON.parse(h);for(i in g){spellWrong.push(g[i])}})}function keyboardShortcut(a){if(a.which!=67&&a.which!=86&&a.which!=88){a.preventDefault();if(shiftDown&&a.which==90){redo()}else{if(a.which==90){undo()}else{if(a.which==83){save(0)}else{if(a.which==82){window.location.href=window.location.href}}}}}}function cut(){if(pos.row!=anch.row||pos.col!=anch.col){backspace()}saveTimer()}function copy(){}function paste(){saveTimer();redoQue=[];if(pos.row!=anch.row||pos.col!=anch.col){backspace()}var c=false;var g=document.getElementById("ccp").value;var f=new RegExp("\\n","g");if(g.split(f).length>1){var e=g.split(f);var b=[];for(x in e){if(e[x]!=""&&e[x]!=null){b.push([e[x],1])}}g=JSON.stringify(b)}undoQue.push(["paste",pos.row,pos.col,g]);if(g[0]=="["&&g[1]=="["){c=true}if(!c){lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col)+g+lines[pos.row][0].slice(pos.col);pos.col+=document.getElementById("ccp").value.length;anch.col=pos.col}else{var a=JSON.parse(g);if(lines[pos.row][0]==""){lines[pos.row][1]=a[0][1]}if(lines[pos.row][1]==a[0][1]){undoQue[undoQue.length-1].push(1);var e=[lines[pos.row][0].slice(pos.col),lines[pos.row][1]];lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col)+a[0][0];var d=1;var h=pos.row+1;while(d<a.length){lines.splice(h,0,a[d]);h++;d++}lines.splice(h,0,e);if(lines[h][0]==""||lines[h][0]==" "){lines.splice(h,1);undoQue[undoQue.length-1].push(0)}else{undoQue[undoQue.length-1].push(1)}}else{undoQue[undoQue.length-1].push(0);var e=[lines[pos.row][0].slice(pos.col),lines[pos.row][1]];lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col);pos.row++;lines.splice(pos.row,0,a[0]);var d=1;var h=pos.row+1;while(d<a.length){lines.splice(h,0,a[d]);h++;d++}lines.splice(h,0,e);if(lines[h][0]==""||lines[h][0]==" "){lines.splice(h,1);undoQue[undoQue.length-1].push(0)}else{undoQue[undoQue.length-1].push(1)}}pos.row=anch.row=h;pos.col=anch.col=0;if(pos.row>=lines.length){pos.row=anch.row=lines.length-1;pos.col=anch.col=lines[pos.row][0].length}}pasting=false;sceneIndex();document.getElementById("canvas").height=$("#container").height()-65;document.getElementById("sidebar").style.height=($("#container").height()-65)+"px";document.getElementById("sidebar").style.width=($("#container").width()-855)+"px";paint(false,false,true,false)}function selection(){if(pos.row>anch.row){var d={row:anch.row,col:anch.col};var a={row:pos.row,col:pos.col}}else{if(pos.row==anch.row&&pos.col>anch.col){var d={row:anch.row,col:anch.col};var a={row:pos.row,col:pos.col}}else{var d={row:pos.row,col:pos.col};var a={row:anch.row,col:anch.col}}}if(d.row==a.row){var b=lines[d.row][0].slice(d.col,a.col)}else{arr=[];arr.push([lines[d.row][0].slice(d.col),lines[d.row][1]]);d.row+=1;while(d.row<a.row){arr.push([lines[d.row][0],lines[d.row][1]]);d.row+=1}arr.push([lines[a.row][0].slice(0,a.col),lines[a.row][1]]);var b=JSON.stringify(arr)}var e=document.getElementById("ccp");e.value=b;e.focus();e.select()}function setup(){resource_id=window.location.href.split("=")[1];$.post("/scriptcontent",{resource_id:resource_id},function(h){if(h=="not found"){lines=[["Sorry, the script wasn't found.",1]];paint(false,false,true,false);return}var b=JSON.parse(h);var n=b[0];document.getElementById("title").innerHTML=n;var o=b[1];for(var k=0;k<o.length;k++){lines.push([o[k][0],o[k][1]])}if(lines.length==2){pos.row=1;anch.row=1;pos.col=lines[1][0].length;anch.col=pos.col}if(b[2].length!=0){var g=b[2][0];var l=b[2][1];for(w in g){spellWrong.push(g[w])}for(k in l){spellIgnore.push(l[k])}}for(k in b[3]){notes.push(b[3][k])}var f=b[4];var m=document.getElementById("hasAccess");for(k in f){var e=m.appendChild(document.createElement("tr"));e.id=f[k];e.appendChild(document.createElement("td")).appendChild(document.createTextNode(f[k]));var a=e.appendChild(document.createElement("td")).appendChild(document.createElement("a"));a.appendChild(document.createTextNode("Remove Access"));a.href="javascript:removeAccess('"+f[k]+"')"}var d=document.getElementById("canvas");var q=d.getContext("2d");document.getElementById("edit_title_href").href="/titlepage?resource_id="+resource_id;tabs(0);characterInit();sceneIndex();noteIndex();document.getElementById("ccp").focus();document.getElementById("ccp").select();document.getElementById("saveButton").value="Saved";document.getElementById("saveButton").disabled=true;paint(false,false,true,false);setInterval("paint(false,false, false,false)",40)})}function tabs(a){var b=["sceneTab","noteTab"];for(i in b){var d=document.getElementById(b[i]);if(i==a){d.style.backgroundColor="#3F5EA6";d.style.color="white";document.getElementById(b[i].replace("Tab","s")).style.display="block"}else{d.style.backgroundColor="#6C8CD5";d.style.color="black";document.getElementById(b[i].replace("Tab","s")).style.display="none"}}}function changeFormat(a){saveTimer();undoQue.push(["format",pos.row,pos.col,lines[pos.row][1],a]);redoQue=[];lines[pos.row][1]=a;anch.col=pos.col;anch.row=pos.row;if(lines[pos.row][1]==4){if(lines[pos.row][0].charAt(0)!="("){lines[pos.row][0]="("+lines[pos.row][0];pos.col++;anch.col++}if(lines[pos.row][0].charAt(lines[pos.row][0].length-1)!=")"){lines[pos.row][0]=lines[pos.row][0]+")"}}if(lines[pos.row][1]==3){if(lines[pos.row][0].charAt(0)=="("){lines[pos.row][0]=lines[pos.row][0].substr(1);pos.col--;anch.col--}if(lines[pos.row][0].charAt(lines[pos.row][0].length-1)==")"){lines[pos.row][0]=lines[pos.row][0].slice(0,-1)}}sceneIndex()}function mouseUp(c){mouseDownBool=false;scrollBarBool=false;var b=document.getElementById("canvas").width;var a=document.getElementById("canvas").height;if(c.clientY-headerHeight>a-39&&c.clientY-headerHeight<a&&c.clientX>editorWidth-22&&c.clientX<editorWidth-2){if(c.clientY-headerHeight>a-20){scroll(30)}else{scroll(-30)}}}function mouseDown(l){if(checkSpell){ajaxSpell(pos.row)}var b=false;var n=document.getElementsByTagName("div");for(var g=0;g<n.length;g++){if(n[g].className=="topMenu"&&n[g].style.display=="block"){b=true;var o=n[g]}}if(b){var d=l.target;while(d.nodeName!="DIV"){d=d.parentNode}id=d.id;var k=id.slice(0,-1);if(k=="format"){changeFormat(id.slice(-1))}if(id=="save"){save(0)}else{if(id=="new"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.")}else{newScriptPrompt()}}else{if(id=="open"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.")}else{openPrompt()}}else{if(id=="rename"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.")}else{renamePrompt()}}else{if(id=="exportas"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.");return}else{exportPrompt()}}else{if(id=="duplicate"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.");return}else{duplicate()}}else{if(id=="close"){closeScript()}else{if(id=="undo"){undo()}else{if(id=="redo"){redo()}else{if(id=="cut"){var r=setTimeout("cut()",50)}else{if(id=="copy"){copy()}else{if(id=="paste"){pasting=true;var r=setTimeout("paste()",50)}else{if(id=="insertNote"){viewNotes=true;newThread()}else{if(id=="editTitlePage"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.");return}else{window.open("/titlepage?resource_id="+resource_id)}}else{if(id=="spellCheck"){launchSpellCheck()}else{if(id=="revision"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.");return}else{window.open("/revisionhistory?resource_id="+resource_id)}}else{if(id=="notes"){viewNotes=(viewNotes?false:true)}else{if(id=="collaborators"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.");return}else{sharePrompt()}}else{if(id=="email"){if(resource_id=="Demo"){alert("Sorry, you'll have to login to start doing that.");return}else{emailPrompt()}}}}}}}}}}}}}}}}}}}}o.style.display="none"}else{if(document.getElementById("suggestBox")!=null){if(l.target.className=="suggestItem"){lines[pos.row][0]=l.target.value;pos.col=anch.col=lines[pos.row][0].length}document.getElementById("suggestBox").parentNode.removeChild(document.getElementById("suggestBox"))}else{var q=document.getElementById("canvas").height;var h=(pageBreaks.length+1)*72*lineheight;var p=((q)/h)*(q-39);if(p<20){p=20}if(p>=q-39){p=q-39}var m=(vOffset/(h-q))*(q-39-p)+headerHeight;if(l.clientX>headerHeight&&l.clientX<editorWidth-100&&l.clientY-headerHeight>40){mouseDownBool=true;paint(false,l,false,false)}else{if(l.clientX<editorWidth&&l.clientX>editorWidth-20&&l.clientY>m&&l.clientY<m+p){scrollBarBool=true}}}}}function mouseMove(a){if(scrollBarBool){scrollBarDrag(a)}mouseX=a.clientX;mouseY=a.clientY;if(mouseDownBool){paint(a,false,false,true)}}function scrollBarDrag(d){var c=mouseY-d.clientY;var a=document.getElementById("canvas").height-50;var b=(pageBreaks.length+1)*72*lineheight;vOffset-=b/a*c;if(vOffset<0){vOffset=0}var b=(pageBreaks.length+1)*72*lineheight-document.getElementById("canvas").height+20;if(vOffset>b){vOffset=b+20}}function scroll(a){vOffset+=a;if(vOffset<0){vOffset=0}var b=(pageBreaks.length+1)*72*lineheight-document.getElementById("canvas").height+20;if(vOffset>b){vOffset=b+20}}function jumpTo(a){if(a!=""){var g=parseInt(a.replace("row",""));pos.row=g;anch.row=pos.row;pos.col=lines[pos.row][0].length;anch.col=pos.col}else{var g=pos.row}var c=0;for(var b=0;b<g;b++){for(var d=0;d<pageBreaks.length;d++){if(pageBreaks[d][0]==b){c+=lineheight*(72-pageBreaks[d][1])}}c+=(linesNLB[b].length*lineheight)}vOffset=c;var f=(pageBreaks.length+1)*72*lineheight-document.getElementById("canvas").height;if(vOffset>f){vOffset=f}}function upArrow(){if(typeToScript&&document.getElementById("suggestBox")==null){if(pos.row==0&&pos.col==0){return}var k=lines[pos.row][1];if(k==0){var h=WrapVariableArray[0]}else{if(k==1){var h=WrapVariableArray[1]}else{if(k==2){var h=WrapVariableArray[2]}else{if(k==3){var h=WrapVariableArray[3]}else{if(k==4){var h=WrapVariableArray[4]}else{if(k==5){var h=WrapVariableArray[5]}}}}}}if(lines[pos.row][0].length>h[0]){var l=lines[pos.row][0].split(" ");var a=0;var b=[];while(a<l.length){if(l.slice(a).join().length<=h[0]){b.push(l.slice(a).join().length);a=l.length}else{var m=0;while(l.slice(a,a+m).join().length<h[0]){m++}b.push(l.slice(a,a+m-1).join().length);a+=m-1}}m=0;var g=b[0];while(g<pos.col){m++;g+=b[m]+1}if(m==0){if(checkSpell){ajaxSpell(pos.row)}var c=lines[pos.row-1][1];if(c==0){var d=WrapVariableArray[0]}else{if(c==1){var d=WrapVariableArray[1]}else{if(c==2){var d=WrapVariableArray[2]}else{if(c==3){var d=WrapVariableArray[3]}else{if(c==4){var d=WrapVariableArray[4]}else{if(c==5){var d=WrapVariableArray[5]}}}}}}if(lines[pos.row-1][0].length<d[0]){pos.row--;if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}else{var l=lines[pos.row-1][0].split(" ");var a=0;var b=[];while(a<l.length){if(l.slice(a).join().length<=h[0]){b.push(l.slice(a).join().length);a=l.length}else{var m=0;while(l.slice(a,a+m).join().length<h[0]){m++}b.push(l.slice(a,a+m-1).join().length);a+=m-1}}pos.row--;pos.col+=lines[pos.row][0].length-b[b.length-1];if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}}else{pos.col-=b[m-1]+1;if(pos.col>(g-b[m]-1)){pos.col=g-b[m]-1}}}else{if(pos.row==0){pos.col=0}else{if(checkSpell){ajaxSpell(pos.row)}var c=lines[pos.row-1][1];if(c==0){var d=WrapVariableArray[0]}else{if(c==1){var d=WrapVariableArray[1]}else{if(c==2){var d=WrapVariableArray[2]}else{if(c==3){var d=WrapVariableArray[3]}else{if(c==4){var d=WrapVariableArray[4]}else{if(c==5){var d=WrapVariableArray[5]}}}}}}if(lines[pos.row-1][0].length<d[0]){pos.row--;if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}else{var l=lines[pos.row-1][0].split(" ");var a=0;var b=[];while(a<l.length){if(l.slice(a).join().length<=h[0]){b.push(l.slice(a).join().length);a=l.length}else{var m=0;while(l.slice(a,a+m).join().length<h[0]){m++}b.push(l.slice(a,a+m-1).join().length);a+=m-1}}pos.row--;pos.col+=lines[pos.row][0].length-b[b.length-1];if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}}}if(!shiftDown){anch.col=pos.col;anch.row=pos.row}paint(false,false,false,true)}else{if(document.getElementById("suggestBox")!=null){var e=document.getElementById("focus");e.removeAttribute("id");e=e.previousSibling;if(e==null){e=document.getElementById("suggestBox").lastChild}if(e.nodeType=="#text"){e=e.previousSibling}if(e==null){e=document.getElementById("suggestBox").lastChild}e.id="focus"}}}function downArrow(){if(typeToScript&&document.getElementById("suggestBox")==null){if(pos.row==lines.length-1&&pos.col==lines[pos.row][0].length){return}var h=lines[pos.row][1];if(h==0){var g=WrapVariableArray[0]}else{if(h==1){var g=WrapVariableArray[1]}else{if(h==2){var g=WrapVariableArray[2]}else{if(h==3){var g=WrapVariableArray[3]}else{if(h==4){var g=WrapVariableArray[4]}else{if(h==5){var g=WrapVariableArray[5]}}}}}}if(lines[pos.row][0].length>g[0]){var k=lines[pos.row][0].split(" ");var a=0;var b=[];while(a<k.length){if(k.slice(a).join().length<=g[0]){b.push(k.slice(a).join().length);a=k.length}else{var l=0;while(k.slice(a,a+l).join().length<g[0]){l++}b.push(k.slice(a,a+l-1).join().length);a+=l-1}}l=0;var e=b[0];while(e<pos.col){l++;e+=b[l]+1}if(l+1==b.length){if(checkSpell){ajaxSpell(pos.row)}for(var c=0;c<b.length-1;c++){pos.col-=b[c]}pos.col--;pos.row++;if(pos.row>lines.length-1){pos.row--;pos.col=lines[pos.row][0].length}if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}else{pos.col+=b[l]+1;if(pos.col>(e+b[l+1]+1)){pos.col=e+b[l+1]+1}}}else{if(pos.row==lines.length-1){pos.col=lines[pos.row][0].length}else{pos.row++;if(pos.row>lines.length-1){pos.row=lines.length-1}if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}}}if(!shiftDown){anch.col=pos.col;anch.row=pos.row}paint(false,false,false,true)}else{if(document.getElementById("suggestBox")!=null){var d=document.getElementById("focus");d.removeAttribute("id");d=d.nextSibling;if(d==null){d=document.getElementById("suggestBox").firstChild}if(d.nodeType=="#text"){d=d.nextSibling}if(d==null){d=document.getElementById("suggestBox").firstChild}d.id="focus"}}}function leftArrow(){if(typeToScript){var b=false;if(pos.row==0&&pos.col==0){return}if(pos.col==0){if(checkSpell){ajaxSpell(pos.row)}pos.row--;pos.col=lines[pos.row][0].length;var b=true}else{pos.col=pos.col-1}if(!shiftDown){anch.col=pos.col;anch.row=pos.row}var a=document.getElementById("suggestBox");if(b&&a!=null){a.parentNode.removeChild(a)}}}function rightArrow(){if(typeToScript){var b=false;if(pos.col==lines[pos.row][0].length&&pos.row==lines.length-1){return}if(pos.col==lines[pos.row][0].length){if(checkSpell){ajaxSpell(pos.row)}pos.row++;pos.col=0;b=true}else{pos.col=pos.col+1}if(!shiftDown){anch.col=pos.col;anch.row=pos.row}var a=document.getElementById("suggestBox");if(b&&a!=null){a.parentNode.removeChild(a)}}}function backspace(g){if(typeToScript){saveTimer();redoQue=[];if(g){g.preventDefault()}var b=false;var c=false;if(lines[pos.row][1]==0){var c=true}if(pos.row==anch.row&&pos.col==anch.col){if(pos.col==0&&pos.row==0){return}else{if(lines[pos.row][1]==4&&pos.col==1){for(x in notes){if(pos.row<notes[x][0]){notes[x][0]=notes[x][0]-1}else{if(pos.row==notes[x][0]){notes[x][1]=notes[x][1]+lines[pos.row-1][0].length;notes[x][0]=notes[x][0]-1}}if(notes[x][1]<0){notes[x][1]=0}}var d=lines[pos.row][0];if(d.charAt(0)=="("){d=d.substr(1)}if(d.charAt(d.length-1)==")"){d=d.slice(0,-1)}var h=lines[pos.row-1][0].length;lines.splice(pos.row,1);pos.row--;pos.col=h;lines[pos.row][0]=lines[pos.row][0]+d;undoQue.push(["back",pos.row,pos.col,"line",4]);c=true}else{if(pos.col==0){for(x in notes){if(pos.row<notes[x][0]){notes[x][0]=notes[x][0]-1}else{if(pos.row==notes[x][0]){notes[x][1]=notes[x][1]+lines[pos.row-1][0].length;notes[x][0]=notes[x][0]-1}}if(notes[x][1]<0){notes[x][1]=0}}var a=lines[pos.row][1];var d=lines[pos.row][0];lines.splice(pos.row,1);var h=lines[pos.row-1][0].length;lines[pos.row-1][0]=lines[pos.row-1][0]+d;pos.col=h;pos.row--;undoQue.push(["back",pos.row,pos.col,"line",a]);b=true;c=true}else{undoQue.push(["back",pos.row,pos.col,lines[pos.row][0][pos.col-1]]);lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col-1)+lines[pos.row][0].slice(pos.col);pos.col--;for(x in notes){if(pos.row==notes[x][0]){if(pos.col<notes[x][1]){notes[x][1]=notes[x][1]-1}}}}}}anch.col=pos.col;anch.row=pos.row}else{b=true;var l=false;if(anch.row>pos.row){l=true}if(anch.row==pos.row&&anch.col>pos.col){l=true}if(l){var k=anch.row;anch.row=pos.row;pos.row=k;k=anch.col;anch.col=pos.col;pos.col=k}var f=0;while(pos.col!=anch.col||pos.row!=anch.row){f++;if(lines[pos.row][1]==0){c=true}if(pos.col==0){for(x in notes){if(pos.row<notes[x][0]){notes[x][0]=notes[x][0]-1}else{if(pos.row==notes[x][0]){notes[x][1]=notes[x][1]+lines[pos.row-1][0].length;notes[x][0]=notes[x][0]-1}}if(notes[x][1]<0){notes[x][1]=0}}var a=lines[pos.row][1];var d=lines[pos.row][0];lines.splice(pos.row,1);var h=lines[pos.row-1][0].length;lines[pos.row-1][0]=lines[pos.row-1][0]+d;pos.col=h;pos.row--;undoQue.push(["back",pos.row,pos.col,"line",a]);c=true}else{undoQue.push(["back",pos.row,pos.col,lines[pos.row][0][pos.col-1]]);lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col-1)+lines[pos.row][0].slice(pos.col);pos.col--;for(x in notes){if(pos.row==notes[x][0]){if(pos.col<notes[x][1]){notes[x][1]=notes[x][1]-1}}}}}undoQue.push(["br",f])}paint(false,false,b,false);if(c){sceneIndex()}}}function deleteButton(){if(typeToScript){saveTimer();redoQue=[];var a=false;var e=false;if(pos.row==anch.row&&pos.col==anch.col){if(lines[pos.row][1]==0){var a=true}if(pos.col==(lines[pos.row][0].length)&&pos.row==lines.length-1){return}if(lines[pos.row][1]==4&&lines[pos.row][0]=="()"){undoQue.push(["delete",pos.row,pos.col,"line",4]);lines.splice(pos.row,1);pos.col=0;anch.col=0}else{if(pos.col==(lines[pos.row][0].length)){for(x in notes){if(pos.row+1==notes[x][0]){notes[x][1]=notes[x][1]+lines[pos.row][0].length;notes[x][0]=notes[x][0]-1}else{if(pos.row<notes[x][0]){notes[x][0]=notes[x][0]-1}}if(notes[x][1]<0){notes[x][1]=0}}undoQue.push(["delete",pos.row,pos.col,"line",lines[pos.row+1][1]]);if(lines[pos.row+1][1]==0){a=true}var b=lines[pos.row+1][0];lines.splice((pos.row+1),1);lines[pos.row][0]+=b;e=true}else{undoQue.push(["delete",pos.row,pos.col,lines[pos.row][0][pos.col]]);lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col)+lines[pos.row][0].slice(pos.col+1);for(x in notes){if(pos.row==notes[x][0]){if(pos.col<notes[x][1]){notes[x][1]=notes[x][1]-1}}}}}}else{e=true;var f=false;if(anch.row>pos.row){f=true}if(anch.row==pos.row&&anch.col>pos.col){f=true}if(f){var d=anch.row;anch.row=pos.row;pos.row=d;d=anch.col;anch.col=pos.col;pos.col=d}var g=0;while(pos.col!=anch.col||pos.row!=anch.row){g++;if(lines[pos.row][1]==0){a=true}if(pos.col==0){for(x in notes){if(pos.row+1==notes[x][0]){notes[x][1]=notes[x][1]+lines[pos.row][0].length;notes[x][0]=notes[x][0]-1}else{if(pos.row<notes[x][0]){notes[x][0]=notes[x][0]-1}}if(notes[x][1]<0){notes[x][1]=0}}undoQue.push(["delete",pos.row-1,lines[pos.row-1][0].length,"line",lines[pos.row][1]]);var b=lines[pos.row][0];lines.splice(pos.row,1);var c=lines[pos.row-1][0].length;lines[pos.row-1][0]=lines[pos.row-1][0]+b;pos.col=c;pos.row--;a=true}else{undoQue.push(["delete",pos.row,pos.col,lines[pos.row][0][pos.col-1]]);lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col-1)+lines[pos.row][0].slice(pos.col);pos.col--;for(x in notes){if(pos.row==notes[x][0]){if(pos.col<notes[x][1]){notes[x][1]=notes[x][1]-1}}}}}undoQue.push(["dr",g])}paint(false,false,e,false);if(a){sceneIndex()}}}function enter(){if(typeToScript&&document.getElementById("suggestBox")==null){saveTimer();if(checkSpell){ajaxSpell(pos.row)}lines[pos.row][0]=lines[pos.row][0].replace(/\s+$/,"");for(x in notes){if(pos.row<notes[x][0]){notes[x][0]=notes[x][0]+1}if(pos.row==notes[x][0]&&pos.col<notes[x][1]){notes[x][1]=notes[x][1]-pos.col;notes[x][0]=notes[x][0]+1}}undoQue.push(["enter",pos.row,pos.col]);redoQue=[];if(lines[pos.row][1]==2){characterIndex(lines[pos.row][0])}var c=lines[pos.row][0].slice(0,pos.col);var b=lines[pos.row][0].slice(pos.col);lines[pos.row][0]=c;if(lines[pos.row][1]==0){var d=1}else{if(lines[pos.row][1]==1){var d=2}else{if(lines[pos.row][1]==2){var d=3}else{if(lines[pos.row][1]==4){var d=3}else{if(lines[pos.row][1]==3){var d=2}else{if(lines[pos.row][1]==5){var d=0}}}}}}var e=[b,d];lines.splice(pos.row+1,0,e);pos.row++;pos.col=0;anch.row=pos.row;anch.col=pos.col;paint(false,false,true,"enter");paint(false,false,false,"enter")}else{if(document.getElementById("suggestBox")!=null){saveTimer();var a=lines[pos.row][0].length;lines[pos.row][0]=document.getElementById("focus").value;undoQue.push(["paste",pos.row,pos.col,lines[pos.row][0].substr(a)]);document.getElementById("suggestBox").parentNode.removeChild(document.getElementById("suggestBox"));pos.col=anch.col=lines[pos.row][0].length}}sceneIndex()}function tab(){if(typeToScript){saveTimer();undoQue.push(["format",pos.row,pos.col,lines[pos.row][1],"tab"]);redoQue=[];var a=false;if(lines[pos.row][1]==0){var a=true}var b=lines[pos.row][1];if(b==1){lines[pos.row][1]=0;a=true}else{if(b==0){lines[pos.row][1]=2}else{if(b==2){lines[pos.row][1]=1}else{if(b==3){lines[pos.row][1]=4}else{if(b==4){lines[pos.row][1]=3}else{if(b==5){lines[pos.row][1]=0;a=true}}}}}}if(a){sceneIndex()}if(lines[pos.row][1]==4){if(lines[pos.row][0].charAt(0)!="("){lines[pos.row][0]="("+lines[pos.row][0];pos.col++;anch.col++}if(lines[pos.row][0].charAt(lines[pos.row][0].length-1)!=")"){lines[pos.row][0]=lines[pos.row][0]+")"}}if(lines[pos.row][1]==3){if(lines[pos.row][0].charAt(0)=="("){lines[pos.row][0]=lines[pos.row][0].substr(1);pos.col--;anch.col--}if(lines[pos.row][0].charAt(lines[pos.row][0].length-1)==")"){lines[pos.row][0]=lines[pos.row][0].slice(0,-1)}}}}function handlekeypress(a){if(typeToScript){a.preventDefault();redoQue=[];var b=new Date();milli=b.getMilliseconds();if(a.which!=13&&a.which!=37&&a.which!=0&&a.which!=8&&!commandDownBool){if(pos.row!=anch.row||pos.col!=anch.col){deleteButton()}undoQue.push([String.fromCharCode(a.charCode),pos.row,pos.col]);lines[pos.row][0]=lines[pos.row][0].slice(0,pos.col)+String.fromCharCode(a.charCode)+lines[pos.row][0].slice(pos.col);pos.col++;if(lines[pos.row][1]==0){sceneIndex()}if(lines[pos.row][1]==2){createSuggestBox("c")}if(lines[pos.row][1]==0){createSuggestBox("s")}for(x in notes){if(pos.row==notes[x][0]){if(pos.col-1<=notes[x][1]){notes[x][1]=notes[x][1]+1}}}saveTimer();anch.col=pos.col;anch.row=pos.row}document.getElementById("ccp").focus();document.getElementById("ccp").select()}}function undo(){saveTimer();if(undoQue.length==0){return}var b=undoQue.pop();var h=[];for(x in b){h.push(b[x])}redoQue.push(h);var c=false;if(b[0]=="enter"){var f=lines[b[1]+1][0];lines.splice((b[1]+1),1);if(lines[b[1]][1]==4&&lines[b[1]][0].charAt(lines[b[1]][0].length-1)==")"){lines[b[1]][0]=lines[b[1]][0].slice(0,-1)}lines[b[1]][0]+=f;c=true}else{if(b[0]=="back"){if(b[3]=="line"){for(x in notes){if(b[1]==notes[x][0]){if(b[2]<=notes[x][1]){notes[x][0]=notes[x][0]+1;notes[x][1]=notes[x][1]-b[2]}}else{if(b[1]<notes[x][0]){notes[x][0]=notes[x][0]+1}}}var f=lines[b[1]][0].slice(0,b[2]);var e=lines[b[1]][0].slice(b[2]);if(b[4]==3&&e.charAt(e.length-1)==")"){e=e.slice(0,-1)}lines[b[1]][0]=f;var g=[e,b[4]];lines.splice(b[1]+1,0,g);b[1]=b[1]+1;b[2]=0;c=true}else{lines[b[1]][0]=lines[b[1]][0].slice(0,b[2]-1)+b[3]+lines[b[1]][0].slice(b[2]-1);for(x in notes){if(b[1]==notes[x][0]){if(b[2]<=notes[x][1]){notes[x][1]=notes[x][1]+1}}}}}else{if(b[0]=="delete"){if(b[3]=="line"){var f=lines[b[1]][0].slice(0,b[2]);var e=lines[b[1]][0].slice(b[2]);if(b[4]==3&&e.charAt(e.length-1)==")"){e=e.slice(0,-1)}lines[b[1]][0]=f;var g=[e,b[4]];lines.splice(b[1]+1,0,g);c=true}else{lines[b[1]][0]=lines[b[1]][0].slice(0,b[2])+b[3]+lines[b[1]][0].slice(b[2])}}else{if(b[0]=="format"){lines[b[1]][1]=b[3];if(lines[b[1]][0].charAt(0)=="("){lines[b[1]][0]=lines[b[1]][0].substr(1)}if(lines[b[1]][0].charAt(lines[b[1]][0].length-1)==")"){lines[b[1]][0]=lines[b[1]][0].slice(0,-1)}}else{if(b[0]=="br"||b[0]=="dr"){var a=b[1];for(var l=0;l<a;l++){var b=undoQue.pop();h=[];for(x in b){h.push(b[x])}redoQue.splice(redoQue.length-1,0,h);if(b[3]=="line"){var f=lines[b[1]][0].slice(0,b[2]);var e=lines[b[1]][0].slice(b[2]);if(b[4]==3&&e.charAt(e.length-1)==")"){e=e.slice(0,-1)}lines[b[1]][0]=f;var g=[e,b[4]];lines.splice(b[1]+1,0,g);b[1]=b[1]+1;b[2]=0;c=true}else{lines[b[1]][0]=lines[b[1]][0].slice(0,b[2]-1)+b[3]+lines[b[1]][0].slice(b[2]-1)}}}else{if(b[0]=="paste"){if(b[3][0]!="["&&b[3][1]!="["){lines[b[1]][0]=lines[b[1]][0].slice(0,b[2])+lines[b[1]][0].slice(b[2]+b[3].length)}else{var m=JSON.parse(b[3]);if(b[4]==0){lines.splice(b[1]+1,m.length);if(b[5]==1){lines[b[1]][0]=lines[b[1]][0]+lines[b[1]+1][0];lines.splice(b[1]+1,1)}}else{lines[b[1]][0]=lines[b[1]][0].slice(0,b[2]);lines.splice(b[1]+1,m.length-1);if(b[5]==1){lines[b[1]][0]=lines[b[1]][0]+lines[b[1]+1][0];lines.splice(b[1]+1,1)}}}}else{lines[b[1]][0]=lines[b[1]][0].slice(0,b[2])+lines[b[1]][0].slice(b[2]+1);if(lines[b[1]][1]==4&&lines[b[1]][0][b[2]-1]==")"){lines[b[1]][0]=lines[b[1]][0].slice(0,b[2])+lines[b[1]][0].slice(b[2]+1);b[2]=b[2]-1}for(x in notes){if(b[1]==notes[x][0]){if(b[2]<notes[x][1]){notes[x][1]=notes[x][1]-1}}}}}}}}}pos.row=b[1];pos.col=b[2];anch.row=pos.row;anch.col=pos.col;sceneIndex();paint(false,false,true,false)}function redo(){saveTimer();if(redoQue.length==0){return}var c=redoQue.pop();var l=[];for(x in c){l.push(c[x])}undoQue.push(l);var d=false;if(c[0]=="enter"){var f=lines[c[1]][0].slice(0,c[2]);var e=lines[c[1]][0].slice(c[2]);lines[c[1]][0]=f;if(lines[c[1]][1]==0){var o=1}else{if(lines[c[1]][1]==1){var o=2}else{if(lines[c[1]][1]==2){var o=3}else{if(lines[c[1]][1]==4){var o=3}else{if(lines[c[1]][1]==3){var o=2}else{if(lines[c[1]][1]==5){var o=0}}}}}}var h=[e,o];lines.splice(c[1]+1,0,h);c[1]=c[1]+1;c[2]=0}else{if(c[0]=="back"){if(c[3]!="line"){lines[c[1]][0]=lines[c[1]][0].slice(0,c[2]-1)+lines[c[1]][0].slice(c[2]);c[2]=c[2]-1}else{var f=lines[c[1]+1][0];lines.splice(c[1]+1,1);lines[c[1]][0]=lines[c[1]][0]+f}}else{if(c[0]=="delete"){if(c[3]!="line"){lines[c[1]][0]=lines[c[1]][0].slice(0,c[2])+lines[c[1]][0].slice(c[2]+1)}else{var f=lines[c[1]+1][0];lines.splice(c[1]+1,1);lines[c[1]][0]=lines[c[1]][0]+f}}else{if(c[0]=="format"){if(c[4]!="tab"){lines[c[1]][1]=c[4]}else{var f=c[3];if(f==0){lines[c[1]][1]=2}else{if(f==1){lines[c[1]][1]=0}else{if(f==2){lines[c[1]][1]=1}else{if(f==3){lines[c[1]][1]=4}else{if(f==4){lines[c[1]][1]=3}else{if(f==5){lines[c[1]][1]=0}}}}}}}}else{if(c[0]=="br"){var b=c[1];for(var g=0;g<b;g++){var c=redoQue.pop();l=[];for(x in c){l.push(c[x])}undoQue.splice(undoQue.length-1,0,l);if(c[3]=="line"){var f=lines[c[1]+1][0];lines.splice(c[1]+1,1);lines[c[1]][0]=lines[c[1]][0]+f}else{lines[c[1]][0]=lines[c[1]][0].slice(0,c[2]-1)+lines[c[1]][0].slice(c[2])}}c[2]=c[2]-1}else{if(c[0]=="dr"){var b=c[1];for(var g=0;g<b;g++){var c=redoQue.pop();l=[];for(x in c){l.push(c[x])}undoQue.splice(undoQue.length-1,0,l);if(c[3]=="line"){var f=lines[c[1]+1][0];lines.splice(c[1]+1,1);lines[c[1]][0]=lines[c[1]][0]+f}else{lines[c[1]][0]=lines[c[1]][0].slice(0,c[2]-1)+lines[c[1]][0].slice(c[2])}}c[2]=c[2]-1}else{if(c[0]=="paste"){if(c[3][0]!="["&&c[3][1]!="["){lines[c[1]][0]=lines[c[1]][0].slice(0,c[2])+c[3]+lines[c[1]][0].slice(c[2])}else{var m=JSON.parse(c[3]);if(lines[c[1]][0]==""){lines[c[1]][1]=m[0][1]}if(lines[c[1]][1]==m[0][1]){var l=[lines[c[1]][0].slice(c[2]),lines[c[1]][1]];lines[c[1]][0]=lines[c[1]][0].slice(0,c[2])+m[0][0];var g=1;var a=c[1]+1;while(g<m.length){lines.splice(a,0,m[g]);a++;g++}lines.splice(a,0,l);if(lines[a][0]==""||lines[a][0]==" "){lines.splice(a,1)}}else{var l=[lines[c[1]][0].slice(c[2]),lines[c[1]][1]];lines[c[1]][0]=lines[c[1]][0].slice(0,c[2]);c[1]++;lines.splice(c[1],0,m[0]);var g=1;var a=c[1]+1;while(g<m.length){lines.splice(a,0,m[g]);a++;g++}lines.splice(a,0,l);if(lines[a][0]==""||lines[a][0]==" "){lines.splice(a,1)}}paint(false,false,true,false)}}else{lines[c[1]][0]=lines[c[1]][0].slice(0,c[2])+c[0]+lines[c[1]][0].slice(c[2]);c[2]=c[2]+1}}}}}}}sceneIndex();paint(false,false,true,false)}function pagination(){pageBreaks=[];i=0;var b=0;while(i<lines.length){lineCount=b;while(lineCount+linesNLB[i].length<56){lineCount+=linesNLB[i].length;i++;if(i==lines.length){return}}var a=0;b=0;if(lines[i][1]==3&&lineCount<54&&lineCount+linesNLB[i].length>57){a=55-lineCount;b=1-a;lineCount=56}else{if(lines[i][1]==3&&lineCount<54&&linesNLB[i].length>4){a=linesNLB[i].length-3;b=1-a;lineCount=55}else{if(lines[i][1]==1&&lineCount<55&&lineCount+linesNLB[i].length>57){a=55-lineCount;b=1-a;lineCount=56}else{if(lines[i][1]==1&&lineCount<55&&linesNLB[i].length>4){a=linesNLB[i].length-3;b=1-a;lineCount=55}else{while(lines[i-1][1]==0||lines[i-1][1]==2||lines[i-1][1]==4){i--;lineCount-=linesNLB[i].length}}}}}pageBreaks.push([i,lineCount,a])}}function characterInit(){for(var a=0;a<lines.length;a++){if(lines[a][1]==2){characterIndex(lines[a][0])}}}function characterIndex(b){var a=b.toUpperCase().replace(/\s+$/,"");var d=false;for(var c=0;c<characters.length;c++){if(characters[c][0]==a){characters[c][1]=characters[c][1]+1;d=true}}if(!d){characters.push([a,1])}}function sceneIndex(){scenes=[];var a=0;for(var b=0;b<lines.length;b++){if(lines[b][1]==0){a++;scenes.push([String(a)+") "+lines[b][0].toUpperCase(),b])}}var e=document.getElementById("sceneBox");e.innerHTML="";for(var b=0;b<scenes.length;b++){var d=e.appendChild(document.createElement("p"));d.appendChild(document.createTextNode(scenes[b][0]));d.className="sceneItem";d.id="row"+scenes[b][1]}$(".sceneItem").click(function(){$(this).css("background-color","#999ccc");jumpTo(this.id)});$(".sceneItem").mouseover(function(){$(this).css("background-color","#ccccff")});$(".sceneItem").mouseout(function(){$(this).css("background-color","white")})}function sortNotes(d,c){if(d[0]<c[0]){return -1}if(d[0]>c[0]){return 1}if(d[1]<c[1]){return -1}if(d[1]>c[1]){return 1}return 0}function sortNotesCol(d,c){if(d[1]<c[1]){return -1}if(d[1]>c[1]){return 1}return 0}function noteIndex(){notes.sort(sortNotes);console.log(notes);var g=document.getElementById("noteBox");g.innerHTML="";for(x in notes){var b=g.appendChild(document.createElement("div"));b.className="thread";var f=b.appendChild(document.createElement("table"));f.width="100%";var d=f.appendChild(document.createElement("tr"));d.appendChild(document.createElement("td"));var k=d.appendChild(document.createElement("td"));k.align="right";var a=k.appendChild(document.createElement("a"));a.style.backgroundColor="orange";a.appendChild(document.createTextNode("Delete"));a.href="javascript:deleteThread('"+notes[x][3]+"')";a.style.textDecoration="none";a.style.color="black";for(y in notes[x][2]){var h=b.appendChild(document.createElement("div"));var e=h.appendChild(document.createElement("div"));e.innerHTML=notes[x][2][y][0];var l=h.appendChild(document.createElement("div"));l.appendChild(document.createTextNode(notes[x][2][y][1].split("@")[0]));l.align="right";l.className="msgInfo";h.className="msg";h.id=notes[x][3]+"msg"}var m=b.appendChild(document.createElement("div"));m.className="respond";m.appendChild(document.createTextNode("Respond"));m.id=notes[x][3]}typeToScript=true;$(".respond").click(function(){newMessage(this.id)});$(".msg").click(function(){for(i in notes){if(String(notes[i][3])==String(this.id.replace("msg",""))){pos.row=anch.row=notes[i][0];pos.col=anch.col=notes[i][1]}}paint(false,false,false,false);if(ud>document.getElementById("canvas").height){scroll(ud-document.getElementById("canvas").height+200)}if(ud<0){scroll(ud-200)}})}function newThread(){noteIndex();typeToScript=false;var h=document.getElementById("noteBox");var d=h.appendChild(document.createElement("div"));d.className="thread";id=Math.round(Math.random()*1000000000);var e=true;while(e==true){e=false;for(b in notes){if(String(notes[b][3])==String(id)){id=Math.round(Math.random()*1000000000);e=true}}}var g=d.appendChild(document.createElement("div"));g.className="respondControls";var b=g.appendChild(document.createElement("div"));b.contentEditable=true;b.id="nmi";var f=g.appendChild(document.createElement("input"));f.type="button";f.value="Save";f.id="noteSave";var a=g.appendChild(document.createElement("input"));a.type="button";a.value="Cancel";a.id="noteCancel";$("#noteSave").click(function(){submitNewThread(id)});$("#noteCancel").click(function(){noteIndex()});b.focus()}function submitNewThread(b){var e=document.getElementById("nmi").innerHTML;var c=document.getElementById("user_email").innerHTML;var g=new Date();if(e!=""){var a=[pos.row,pos.col,[[e,c,g]],b];notes.push(a);var f=[pos.row,pos.col,e,b];if(resource_id!="Demo"){$.post("/notesnewthread",{resource_id:resource_id,row:pos.row,col:pos.col,content:e,thread_id:b},function(h){if(h!="sent"){alert("Sorry, there was a problem sending that message. Please try again later.")}})}}noteIndex()}function newMessage(b){noteIndex();typeToScript=false;var g=document.getElementById(b);var f=g.parentNode.insertBefore(document.createElement("div"),g);f.className="respondControls";var d=f.appendChild(document.createElement("div"));d.contentEditable=true;d.id="nmi";var e=f.appendChild(document.createElement("input"));e.type="button";e.value="Save";e.id="noteSave";var a=f.appendChild(document.createElement("input"));a.type="button";a.value="Cancel";a.id="noteCancel";g.parentNode.removeChild(g);$("#noteSave").click(function(){submitMessage(b)});$("#noteCancel").click(function(){noteIndex()});d.focus()}function submitMessage(b){for(x in notes){if(notes[x][3]==b){var g=x}}var f=new Date();var e=document.getElementById("nmi").innerHTML;var c=document.getElementById("user_email").innerHTML;if(e!=""){var a=[e,c,f];notes[g][2].push(a);if(resource_id!="Demo"){$.post("/notessubmitmessage",{resource_id:resource_id,content:e,thread_id:b},function(h){if(h!="sent"){alert("Sorry, there was a problem sending that message. Please try again later.")}})}}noteIndex()}function deleteThread(a){var d=confirm("Are you sure you want to Delete this thread? This cannot be undone.");if(d==true){if(resource_id!="Demo"){$.post("/notesdeletethread",{resource_id:resource_id,thread_id:a})}for(i in notes){if(notes[i][3]==a){var b=i}}notes.splice(b,1);noteIndex()}}function openMenu(a){document.getElementById(a).style.backgroundColor="#6484df";document.getElementById(a).style.color="white";document.getElementById(a+"Menu").style.display="block";var d=document.getElementsByTagName("td");for(var b=0;b<d.length;b++){if(d[b].className=="formatTD"){if(d[b].id=="check"+lines[pos.row][1]){d[b].innerHTML="";d[b].appendChild(document.createTextNode("✓"))}else{d[b].innerHTML=""}}}}function topMenuOver(a){var b=false;var e=document.getElementsByTagName("div");for(var d=0;d<e.length;d++){if(e[d].className=="menuItem"){e[d].style.backgroundColor="#A2BAE9";e[d].style.color="black"}if(e[d].className=="topMenu"){if(e[d].style.display=="block"){e[d].style.display="none";b=true}}}if(b){document.getElementById(a+"Menu").style.display="block"}document.getElementById(a).style.backgroundColor="#6484df";document.getElementById(a).style.color="white";var e=document.getElementsByTagName("td");for(var d=0;d<e.length;d++){if(e[d].className=="formatTD"){if(e[d].id=="check"+lines[pos.row][1]){e[d].innerHTML="";e[d].appendChild(document.createTextNode("✓"))}else{e[d].innerHTML=""}}}}function topMenuOut(a){if(document.getElementById(a+"Menu").style.display=="none"){document.getElementById(a).style.backgroundColor="#A2BAE9";document.getElementById(a).style.color="black"}}function closeScript(){var a=JSON.stringify(lines);$.post("/save",{data:a,resource_id:resource_id},function(b){self.close()})}function newScriptPrompt(){typeToScript=false;document.getElementById("newscriptpopup").style.visibility="visible"}function hideNewScriptPrompt(){typeToScript=true;document.getElementById("newScript").value="";document.getElementById("newscriptpopup").style.visibility="hidden"}function createScript(){var a=document.getElementById("newScript").value;if(a!=""){$.post("/newscript",{filename:a},function(b){window.open("/editor?resource_id="+b)})}hideNewScriptPrompt()}function duplicate(){$.post("/duplicate",{resource_id:resource_id,fromPage:"editor"},function(a){if(a=="fail"){return}else{window.open(a)}})}function save(b){clearTimeout(timer);if(resource_id=="Demo"){if(b==0){alert("Sorry, but you'll have to login to start saving scripts!")}return}var c=JSON.stringify(lines);document.getElementById("saveButton").value="Saving...";$.post("/save",{data:c,resource_id:resource_id,autosave:b},function(e){document.getElementById("saveButton").value="Saved";document.getElementById("saveButton").disabled=true});var a=[];for(i in notes){a.push([notes[i][0],notes[i][1],notes[i][3]])}if(a.length!=0){$.post("/notesposition",{resource_id:resource_id,positions:JSON.stringify(a)},function(e){})}}function openPrompt(){typeToScript=false;var a=document.getElementById("openTable");a.innerHTML="Loading... ";document.getElementById("openpopup").style.visibility="visible";$.post("/list",function(e){a.innerHTML="";var d=JSON.parse(e);var c=d[0];var f=a.appendChild(document.createElement("tr"));var b=f.appendChild(document.createElement("td"));b.appendChild(document.createTextNode("Title"));b.style.textDecoration="underline";b=f.appendChild(document.createElement("td"));b.appendChild(document.createTextNode("Updated"));b.style.textDecoration="underline";for(i in c){var f=a.appendChild(document.createElement("tr"));var g=f.appendChild(document.createElement("td")).appendChild(document.createElement("a"));g.appendChild(document.createTextNode(c[i][1]));g.href="/editor?resource_id="+c[i][0];g.target="_blank";f.appendChild(document.createElement("td")).appendChild(document.createTextNode(c[i][2]))}})}function hideOpenPrompt(){document.getElementById("openpopup").style.visibility="hidden";typeToScript=true}function renamePrompt(){typeToScript=false;document.getElementById("renameTitle").innerHTML="Rename: "+document.getElementById("title").innerHTML;document.getElementById("renameField").value=document.getElementById("title").innerHTML;document.getElementById("renamepopup").style.visibility="visible"}function hideRenamePrompt(){document.getElementById("renameField").value="";document.getElementById("renamepopup").style.visibility="hidden";typeToScript=true}function renameScript(){var a=document.getElementById("renameField").value;if(a==""){return}document.getElementById("title").innerHTML=a;$.post("/rename",{resource_id:resource_id,rename:a,fromPage:"scriptlist"});hideRenamePrompt()}function exportPrompt(){if(document.getElementById("saveButton").value=="Save"){save(0)}typeToScript=false;document.getElementById("exportpopup").style.visibility="visible"}function hideExportPrompt(){typeToScript=true;document.getElementById("exportpopup").style.visibility="hidden"}function exportScripts(){var e=window.location.href;var g=e.split("=")[1];if(g=="demo"){nope();return}else{var k;var h="&title_page="+document.getElementById("et").selectedIndex;var f=document.getElementsByTagName("input");for(var l=0;l<f.length;l++){if(f[l].checked==true){if(f[l].className=="exportList"){k=f[l].name;e="/export?resource_id="+g+"&export_format="+k+"&fromPage=editor"+h;window.open(e)}}}}}function emailPrompt(){if(document.getElementById("saveButton").value=="Save"){save(0)}typeToScript=false;document.getElementById("emailpopup").style.visibility="visible"}function hideEmailPrompt(){document.getElementById("emailpopup").style.visibility="hidden";document.getElementById("recipient").value="";document.getElementById("recipients").innerHTML="";document.getElementById("message").innerHTML="";typeToScript=true}function emailComplete(a){document.getElementById("emailS").disabled=false;document.getElementById("emailS").value="Send";if(a=="sent"){alert("Email Sent");hideEmailPrompt()}else{alert("There was a problem sending your email. Please try again later.")}}function emailScript(){tokenize("recipient");var b=new Array();var g=document.getElementsByTagName("span");for(var e=0;e<g.length;e++){if(g[e].className=="mailto"){b.push(g[e].innerHTML)}}var a=b.join(",");var d=document.getElementById("subject").value;if(d==""){d="Script"}var f=document.getElementById("message").innerHTML;$.post("/emailscript",{resource_id:resource_id,recipients:a,subject:d,body_message:f,fromPage:"editor",title_page:document.getElementById("emailTitle").selectedIndex},function(c){emailComplete(c)});document.getElementById("emailS").disabled=true;document.getElementById("emailS").value="Sending..."}function sharePrompt(){typeToScript=false;document.getElementById("sharepopup").style.visibility="visible"}function hideSharePrompt(){typeToScript=true;document.getElementById("sharepopup").style.visibility="hidden";document.getElementById("collaborator").value=""}function removeAccess(a){var b=confirm("Are you sure you want to remove access for this user?");if(b==true){var b=document.getElementById(a);b.style.backgroundColor="#ccc";$.post("/removeaccess",{resource_id:resource_id,removePerson:a},function(c){document.getElementById(c).parentNode.removeChild(document.getElementById(c))})}}function shareScript(){tokenize("collaborator");var a=new Array();var e=document.getElementsByTagName("span");for(var b=0;b<e.length;b++){if(e[b].className=="mailto"){a.push(e[b].innerHTML)}}var d=a.join(",");$.post("/share",{resource_id:resource_id,collaborators:d,fromPage:"scriptlist"},function(g){var f=g.split(",");var l=document.getElementById("hasAccess");for(b in f){var h=l.appendChild(document.createElement("tr"));h.id=f[b];h.appendChild(document.createElement("td")).appendChild(document.createTextNode(f[b]));var k=h.appendChild(document.createElement("td")).appendChild(document.createElement("a"));k.appendChild(document.createTextNode("Remove Access"));k.href="javascript:removeAccess('"+f[b]+"')"}document.getElementById("shareS").disabled=false;document.getElementById("shareS").value="Send Invitations"});document.getElementById("shareS").disabled=true;document.getElementById("shareS").value="Sending Invites...";document.getElementById("collaborators").innerHTML=""}function launchSpellCheck(){typeToScript=false;ajaxSpell(pos.row);var a=(pos.row==0?true:false);document.getElementById("spellcheckpopup").style.visibility="visible";spellCheckCycle(a,0,0)}function spellCheckCycle(l,a,n){if(a=="finished"){alert("Spell Check Complete");hideSpellCheck();return}var q=lines[a][0].split(" ");var p=false;while(p==false){var b=q[n].replace("?","").replace(".","").replace(",","").replace("(","").replace(")","");for(i in spellWrong){if(spellWrong[i][0].toUpperCase()==b.toUpperCase()){p=[a,n,i,];for(v in spellIgnore){if(spellIgnore[v].toUpperCase()==b.toUpperCase()){p=false}}}}if(!p){n++;if(n==q.length){n=0;a++;if(a==lines.length){p="finished"}else{q=lines[a][0].split(" ")}}}}if(p=="finished"){document.getElementById("sSuggest").innerHTML="";document.getElementById("sSentance").innerHTML="";alert("Spell Check Complete");hideSpellCheck()}else{var c=lines[a][0];var e=new RegExp(b,"i");var k="<span id='sFocus' title='"+b+"' style='color:red'>"+b+"</span>";c=c.replace(e,k);if(lines[a][1]==0||lines[a][1]==2||lines[a][1]==5){document.getElementById("sSentance").innerHTML=c.toUpperCase();document.getElementById("sSentance").innerHTML=document.getElementById("sSentance").innerHTML.replace("SFOCUS","sFocus")}else{document.getElementById("sSentance").innerHTML=c}document.getElementById("sSentance").title=a;var m=spellWrong[p[2]][1];var g=document.getElementById("sSuggest");g.innerHTML="";for(i in m){var o=g.appendChild(document.createElement("div"));o.className="spellcheckitem";if(lines[a][1]==0||lines[a][1]==2||lines[a][1]==5){o.appendChild(document.createTextNode(m[i].toUpperCase()))}else{o.appendChild(document.createTextNode(m[i]))}o.title=m[i]}n++;if(n==q.length){n=0;a++;if(a==lines.length){p="finished"}else{q=lines[a][0].split(" ")}}var f=(p=="finished"?p:[a,n].join(","));document.getElementById("sHidden").value=f;$(".spellcheckitem").click(function(){var d=document.getElementById("spellcheckfocus");if(d!=undefined){d.removeAttribute("id")}this.id="spellcheckfocus";document.getElementById("sFocus").innerHTML=this.title})}}function hideSpellCheck(){document.getElementById("spellcheckpopup").style.visibility="hidden";typeToScript=true}function s_ignore(){var a=document.getElementById("sHidden").value;spellCheckCycle(false,a.split(",")[0],a.split(",")[1])}function s_ignore_all(){spellIgnore.push(document.getElementById("sFocus").title);var a=document.getElementById("sHidden").value;spellCheckCycle(false,a.split(",")[0],a.split(",")[1])}function s_change(){var b=document.getElementById("sSentance");var d=b.title;lines[d][0]="";for(i in b.childNodes){if(b.childNodes[i].nodeName=="#text"){lines[d][0]=lines[d][0]+b.childNodes[i].nodeValue}else{var e=b.childNodes[i].childNodes;for(j in e){if(e[j].nodeName=="#text"){lines[d][0]=lines[d][0]+e[j].nodeValue}}}}var a=document.getElementById("sHidden").value;spellCheckCycle(false,a.split(",")[0],a.split(",")[1]);paint(false,false,true,false)}function scrollArrows(b){var a=document.getElementById("canvas").height;b.fillStyle="#333";b.fillRect(editorWidth-22,a-39,20,20);b.fillStyle="#ddd";b.fillRect(editorWidth-20,a-37,16,16);b.beginPath();b.moveTo(editorWidth-18,a-24);b.lineTo(editorWidth-12,a-35);b.lineTo(editorWidth-6,a-24);b.closePath();b.fillStyle="#333";b.fill();b.fillStyle="#333";b.fillRect(editorWidth-22,a-19,20,20);b.fillStyle="#ddd";b.fillRect(editorWidth-20,a-18,16,16);b.beginPath();b.moveTo(editorWidth-18,a-15);b.lineTo(editorWidth-12,a-4);b.lineTo(editorWidth-6,a-15);b.closePath();b.fillStyle="#333";b.fill()}function scrollBar(b,f){var a=document.getElementById("canvas").height;var d=(pageBreaks.length+1)*72*lineheight+40;var e=((a)/d)*(a-39);if(e<20){e=20}if(e>=a-39){e=a-39}var c=(vOffset/(d-a))*(a-39-e);b.fillRect(editorWidth-22,c,20,e)}function drawRange(s){if(pos.row>anch.row){var p={row:anch.row,col:anch.col};var h={row:pos.row,col:pos.col}}else{if(pos.row==anch.row&&pos.col>anch.col){var p={row:anch.row,col:anch.col};var h={row:pos.row,col:pos.col}}else{var p={row:pos.row,col:pos.col};var h={row:anch.row,col:anch.col}}}var r=lineheight*9+3;var m=0;for(var k=0;k<p.row;k++){if(pageBreaks.length!=0&&pageBreaks[m][2]==0&&pageBreaks[m][0]-1==k){r=72*lineheight*(m+1)+9*lineheight+4;m++;if(m==pageBreaks.length){m--}}else{if(pageBreaks.length!=0&&pageBreaks[m][2]!=0&&pageBreaks[m][0]==k){r=72*lineheight*(m+1)+9*lineheight+4;r+=(linesNLB[k].length-pageBreaks[m][2])*lineheight;if(lines[k][1]==3){r+=lineheight}m++;if(m==pageBreaks.length){m--}}else{r+=lineheight*linesNLB[k].length}}}var k=0;var q=linesNLB[p.row][k]+1;while(p.col>q){r+=lineheight;if(pageBreaks.length!=0&&pageBreaks[m][0]==p.row&&pageBreaks[m][2]==k+1){r=72*lineheight*(m+1)+9*lineheight+4;if(lines[p.row][1]==3){r+=lineheight}}k++;q+=linesNLB[p.row][k]+1}q-=linesNLB[p.row][k]+1;var l=WrapVariableArray[lines[p.row][1]][1];l+=((p.col-q)*fontWidth);r+=lineheight;for(note in notes){if(notes[note][0]==p.row){if(q<notes[note][1]&&q+linesNLB[p.row][k]+1>notes[note][1]){if(notes[note][1]<p.col){l+=fontWidth}}}}var d=lineheight*9+3;m=0;for(var g=0;g<h.row;g++){if(pageBreaks.length!=0&&pageBreaks[m][2]==0&&pageBreaks[m][0]-1==g){d=72*lineheight*(m+1)+9*lineheight+4;m++;if(m==pageBreaks.length){m--}}else{if(pageBreaks.length!=0&&pageBreaks[m][2]!=0&&pageBreaks[m][0]==g){d=72*lineheight*(m+1)+9*lineheight+4;d+=(linesNLB[g].length-pageBreaks[m][2])*lineheight;if(lines[g][1]==3){d+=lineheight}m++;if(m==pageBreaks.length){m--}}else{d+=lineheight*linesNLB[g].length}}}var g=0;var n=linesNLB[h.row][g]+1;while(h.col>n){d+=lineheight;if(pageBreaks.length!=0&&pageBreaks[m][0]==h.row&&pageBreaks[m][2]==g+1){d=72*lineheight*(m+1)+9*lineheight+4;if(lines[h.row][1]==3){d+=lineheight}}g++;n+=linesNLB[h.row][g]+1}n-=linesNLB[h.row][g]+1;var b=WrapVariableArray[lines[h.row][1]][1];b+=((h.col-n)*fontWidth);d+=lineheight;for(note in notes){if(notes[note][0]==h.row){if(n<notes[note][1]&&n+linesNLB[h.row][g]+1>notes[note][1]){if(notes[note][1]<h.col){b+=fontWidth}}}}s.fillStyle="lightBlue";if(d==r){var f=l;if(lines[p.row][1]==5){f-=(lines[p.row][0].length*fontWidth)}s.fillRect(f,r-vOffset,b-l,12)}else{var c=l;if(lines[p.row][1]==5){c-=(lines[p.row][0].length*fontWidth)}s.fillRect(c,r-vOffset,(q+linesNLB[p.row][k]-p.col)*fontWidth,12);while(r+lineheight<d){for(var a=0;a<pageBreaks.length;a++){if(pageBreaks.length!=0&&pageBreaks[a][0]-1==p.row&&pageBreaks[a][2]==0&&k==linesNLB[p.row].length-1){r=72*lineheight*(a+1)+9*lineheight+4}else{if(pageBreaks.length!=0&&pageBreaks[a][0]==p.row&&k==pageBreaks[a][2]-1){r=72*lineheight*(a+1)+9*lineheight+4;if(lines[p.row][1]==3){r+=lineheight}}}}k++;r+=lineheight;if(linesNLB[p.row].length<=k){p.row++;k=0}if(r!=d){var e=WrapVariableArray[lines[p.row][1]][1];if(lines[p.row][1]==5){e-=(lines[p.row][0].length*fontWidth)}s.fillRect(e,r-vOffset,linesNLB[p.row][k]*fontWidth,12)}}var o=WrapVariableArray[lines[h.row][1]][1];if(lines[h.row][1]==5){o-=(lines[h.row][0].length*fontWidth)}s.fillRect(o,d-vOffset,(h.col-n)*fontWidth,12)}}function drawNote(f,a,d,b,e){if(lines[e][1]==5){b.fillStyle="gold";b.beginPath();b.moveTo(f-fontWidth*(lines[e][0].length-d+1),a-vOffset-lineheight+3);b.lineTo(f-fontWidth*(lines[e][0].length-d+1),a-vOffset-lineheight+3+lineheight);b.lineTo(f-fontWidth*(lines[e][0].length-d+1)+fontWidth,a-vOffset-lineheight+3+lineheight);b.lineTo(f-fontWidth*(lines[e][0].length-d+1)+fontWidth,a-vOffset-lineheight+3+4);b.lineTo(f-fontWidth*(lines[e][0].length-d+1)+fontWidth-4,a-vOffset-lineheight+3);b.closePath();b.fill();b.strokeStyle="#333";b.lineWidth=1;b.beginPath();for(var c=1;c<6;c++){b.moveTo(f-fontWidth*(lines[e][0].length-d+1)+1,a-vOffset-lineheight+3+(2*c)+0.5);b.lineTo(f-fontWidth*(lines[e][0].length-d+1)+fontWidth-1,a-vOffset-lineheight+3+(2*c)+0.5);b.stroke()}b.strokeStyle="#999";b.beginPath();b.moveTo(f-fontWidth*(lines[e][0].length-d+1)+fontWidth-4,a-vOffset-lineheight+3);b.lineTo(f-fontWidth*(lines[e][0].length-d+1)+fontWidth-4,a-vOffset-lineheight+3+4);b.lineTo(f-fontWidth*(lines[e][0].length-d+1)+fontWidth,a-vOffset-lineheight+3+4);b.stroke()}else{b.fillStyle="gold";b.beginPath();b.moveTo(f+fontWidth*d,a-vOffset-lineheight+3);b.lineTo(f+fontWidth*d,a-vOffset-lineheight+3+lineheight);b.lineTo(f+fontWidth*d+fontWidth,a-vOffset-lineheight+3+lineheight);b.lineTo(f+fontWidth*d+fontWidth,a-vOffset-lineheight+3+4);b.lineTo(f+fontWidth*d+fontWidth-4,a-vOffset-lineheight+3);b.closePath();b.fill();b.strokeStyle="#333";b.lineWidth=1;b.beginPath();for(var e=1;e<6;e++){b.moveTo(f+fontWidth*d+1,a-vOffset-lineheight+3+(2*e)+0.5);b.lineTo(f+fontWidth*d+fontWidth-1,a-vOffset-lineheight+3+(2*e)+0.5);b.stroke()}b.strokeStyle="#999";b.beginPath();b.moveTo(f+fontWidth*d+fontWidth-4,a-vOffset-lineheight+3);b.lineTo(f+fontWidth*d+fontWidth-4,a-vOffset-lineheight+3+4);b.lineTo(f+fontWidth*d+fontWidth,a-vOffset-lineheight+3+4);b.stroke()}b.fillStyle=foreground}function sortNumbers(d,c){return d-c}function paint(ak,E,ac,C){if(typeToScript){var p=document.getElementById("canvas");var A=p.getContext("2d");A.clearRect(0,0,2000,2500);A.fillStyle="#ccc";A.fillRect(0,0,editorWidth,document.getElementById("canvas").height);A.fillStyle=foreground;var Y=45;var W=lineheight;for(var ag=0;ag<=pageBreaks.length;ag++){A.fillStyle=background;A.fillRect(Y,W-vOffset,editorWidth*0.85,lineheight*70);A.strokeStyle="#000";A.lineWidth=1;A.strokeRect(Y,W-vOffset,Math.round(editorWidth*0.85),lineheight*70);A.strokeStyle="#999";A.strokeRect(Y-2,W-vOffset-2,Math.round(editorWidth*0.85)+4,lineheight*70+4);A.fillStyle=foreground;if(ag>0){A.fillText(String(ag+1)+".",645,W-vOffset+85)}W+=lineheight*72}var Q=lineheight*9+2;var O=WrapVariableArray[0];A.fillStyle="#ddd";if(!ac){var X=0;for(var ag=0;ag<lines.length;ag++){if(pageBreaks.length!=0&&pageBreaks[X][0]==ag){Q=72*lineheight*(X+1)+9*lineheight+2;if(pageBreaks[X][2]!=0){Q-=pageBreaks[X][2]*lineheight;if(lines[ag][1]==3){Q+=lineheight}}X++;if(X==pageBreaks.length){X--}}if(ag<linesNLB.length){for(var ae=0;ae<linesNLB[ag].length;ae++){Q+=lineheight;if(lines[ag][1]==0){if(linesNLB[ag][ae]!=0){A.fillRect(O[1]-3,Q-vOffset,61*fontWidth+6,14)}if(lines[ag][0]==""&&ae==0){A.fillRect(O[1]-3,Q-vOffset,61*fontWidth+6,14)}}}}}}A.fillStyle=foreground;if(pos.row!=anch.row||anch.col!=pos.col){drawRange(A);if(!pasting){selection()}}A.fillStyle=foreground;A.font=font;var R=lineheight*11;var h=[];var l="";var X=0;var s=false;var aj=0;for(var ag=0;ag<lines.length;ag++){if(lines[ag][1]==0){aj++}if(lines[ag][1]==4){if(lines[ag][0].charAt(0)!="("){lines[ag][0]="("+lines[ag][0]}if(lines[ag][0].charAt(lines[ag][0].length-1)!=")"){lines[ag][0]=lines[ag][0]+")"}}var ar=false;if(!ac){if(pageBreaks.length!=0&&pageBreaks[X]!=undefined&&pageBreaks[X][0]==ag){if(pageBreaks[X][2]==0){R=72*lineheight*(X+1)+11*lineheight;X++;if(X>=pageBreaks.length){if(!s){s=X+1}X=pageBreaks.length-2}}else{ar=true}}}if(!ac&&!ar&&(R-vOffset>1200||R-vOffset<-200)){R+=(lineheight*linesNLB[ag].length);if(ag==pos.row){var M=R;o=[]}}else{var z=[];if(viewNotes){for(note in notes){if(notes[note][0]==ag){z.push(notes[note][1])}}}z=z.sort(sortNumbers);var at=lines[ag][1];var k=(E?anch.row:pos.row);if(ag==pos.row){var M=R-lineheight;if(at==1){var N=WrapVariableArray[1][1]}else{if(at==0){var N=WrapVariableArray[0][1]}else{if(at==3){var N=WrapVariableArray[3][1]}else{if(at==2){var N=WrapVariableArray[2][1]}else{if(at==4){var N=WrapVariableArray[4][1]}else{if(at==5){var N=WrapVariableArray[5][1]}}}}}}var D=true;var o=[]}if(ag==anch.row){var K=R-lineheight;var P=true;var a=[]}var ah=lines[ag][0];if(at==0){var O=WrapVariableArray[0]}else{if(at==1){var O=WrapVariableArray[1]}else{if(at==2){var O=WrapVariableArray[2]}else{if(at==3){var O=WrapVariableArray[3]}else{if(at==4){var O=WrapVariableArray[4]}else{if(at==5){var O=WrapVariableArray[5]}}}}}}var u=ah.split(" ");var T=0;if(ak||E){var ad=[]}linesNLB[ag]=[];var g=0;var H=false;var b=false;while(T<u.length){var V=0;if(u.slice(T).join().length<O[0]){var ao=u.slice(T).join(" ");if(lines[ag][1]==2&&l!=""&&lines[ag][0].toUpperCase()==l.toUpperCase()){ao+=" (Cont'd)"}if(lines[ag][1]==0){l=""}if(O[3]==1){ao=ao.toUpperCase()}if(O[2]==1){A.textAlign="right"}var an=ao;var ab=[];if(viewNotes){for(note in z){if(z[note]>=lines[ag][0].length-ao.length){an=an.substr(0,z[note]-g+ab.length)+" "+an.substr(z[note]-g+ab.length);drawNote(O[1],R,z[note]-g+ab.length,A,ag);ab.push(z[note])}}}if(ao!=""){A.fillText(an,O[1],R-vOffset)}A.textAlign="left";T=u.length;linesNLB[ag].push(ao.length);R+=lineheight;if(O[4]==2){linesNLB[ag].push(0);R+=lineheight}if(ak||E){ad.push(ao.length)}if(D){o.push(ao.length)}if(P){a.push(ao.length)}}else{var V=0;while(u.slice(T,T+V).join(" ").length<O[0]){newLineToPrint=u.slice(T,T+V).join(" ");V++;if(O[3]==1){newLineToPrint=newLineToPrint.toUpperCase()}}var af=newLineToPrint;var ab=[];if(viewNotes){for(note in z){if(z[note]>=g&&z[note]<=g+newLineToPrint.length){af=af.substr(0,z[note]-g+ab.length)+" "+af.substr(z[note]-g+ab.length);drawNote(O[1],R,z[note]-g+ab.length,A,ag);ab.push(z[note])}}}g+=newLineToPrint.length+1;A.fillText(af,O[1],R-vOffset);linesNLB[ag].push(newLineToPrint.length);R+=lineheight;T+=V-1;V=0;if(ak||E){ad.push(newLineToPrint.length)}if(D){o.push(newLineToPrint.length)}if(P){a.push(newLineToPrint.length)}}if(lines[ag][1]==3&&ag+1!=lines.length&&lines[ag+1][1]==4&&linesNLB[ag][linesNLB[ag].length-1]==0){linesNLB[ag].pop();R-=lineheight}if(ak&&!b&&ak.clientY-headerHeight<R-vOffset-lineheight&&ak.clientY-headerHeight>R-vOffset-(linesNLB[ag].length*lineheight)-lineheight){pos.row=ag;pos.col=0;var V=0;var aa=R-vOffset-(linesNLB[ag].length*lineheight);while(ak.clientY-headerHeight>aa){pos.col+=linesNLB[ag][V]+1;aa+=lineheight;V++}if(at!=5){var F=Math.round(((ak.clientX-O[1])/fontWidth));if(F>linesNLB[ag][V]){F=linesNLB[ag][V]}if(F<0){F=0}pos.col+=F}else{var F=Math.round(((O[1]-ak.clientX)/fontWidth));if(F<0){F=0}pos.col-=F;pos.col+=lines[ag][0].length}if(viewNotes){for(note in ab){if(ab[note]<pos.col){pos.col--}}}var L=0;for(var am=0;am<ad.length;am++){L+=ad[am]+1}if(pos.col<0){pos.col=0}if(pos.col>lines[pos.row][0].length){pos.col=lines[pos.row][0].length}b=true}if(E&&!H&&E.clientY-headerHeight<R-vOffset-lineheight&&E.clientY-headerHeight>R-vOffset-(linesNLB[ag].length*lineheight)-lineheight){anch.row=ag;anch.col=0;var V=0;var aa=R-vOffset-(linesNLB[ag].length*lineheight);while(E.clientY-headerHeight>aa){anch.col+=linesNLB[ag][V]+1;aa+=lineheight;V++}if(at!=5){var F=Math.round(((E.clientX-O[1])/fontWidth));if(F>linesNLB[ag][V]){F=linesNLB[ag][V]}if(F<0){F=0}anch.col+=F}else{var F=Math.round(((O[1]-E.clientX)/fontWidth));if(F<0){F=0}anch.col-=F;anch.col+=lines[ag][0].length}if(viewNotes){for(note in ab){if(ab[note]<anch.col){anch.col--}}}var L=0;for(var am=0;am<ad.length;am++){L+=ad[am]+1}if(anch.col<0){anch.col=0}if(anch.col>lines[anch.row][0].length){anch.col=lines[anch.row][0].length}H=true}if(ar&&linesNLB[ag].length==pageBreaks[X][2]){if(lines[ag][1]==3){A.fillText("(MORE)",WrapVariableArray[2][1],R-vOffset)}R=72*lineheight*(X+1)+11*lineheight;if(lines[ag][1]==3){A.fillText(l.toUpperCase()+" (CONT'D)",WrapVariableArray[2][1],R-vOffset);R+=lineheight}X++;ar=false;if(pos.row==ag){h.push(X)}}}var D=false;var P=false}if(lines[ag][1]==2){var l=lines[ag][0]}if(ag==pos.row&&s==false){s=X+1}if(ag==pos.row){var aq=aj;var f=z}if(X>=pageBreaks.length){if(s==false){s=X+1}X=pageBreaks.length-2}}while(lines.length<linesNLB.length){linesNLB.pop()}var al=new Date();var B=al.getMilliseconds();var I=B-milli;var m=false;if(I>0&&I<500){m=true}if(I<0&&I<-500){m=true}if(o){var S=0;var t=pos.col;var r=o[S];while(pos.col>r){S++;r+=1+o[S]}r-=o[S];var U=0;for(note in f){var Z=f[note];console.log();if(Z<pos.col&&Z>r&&Z<r+o[S]){U++}}if(h.length>0&&S>=pageBreaks[h[0]-1][2]){s+=1;M=72*h[0]*lineheight+9*lineheight;if(lines[pos.row][1]==3){M+=lineheight*2;S-=pageBreaks[h[0]-1][2]}else{if(lines[pos.row][1]==1){S-=pageBreaks[h[0]-1][2];M+=lineheight}}}if(m){var J=N+((pos.col-r+U)*fontWidth);if(lines[pos.row][1]==5){J-=lines[pos.row][0].length*fontWidth}ud=2+M+(S*lineheight)-vOffset;try{A.fillRect(J,ud,2,17)}catch(ai){console.log(lines[pos.row][0])}}}A.lineWidth=4;A.strokeStyle="#ddd";A.beginPath();A.moveTo(2,2);A.lineTo(2,document.getElementById("canvas").height-1);A.lineTo(editorWidth,document.getElementById("canvas").height-1);A.lineTo(editorWidth,2);A.lineTo(2,2);A.stroke();A.fillStyle="#aaa";A.fillRect(3,document.getElementById("canvas").height-24,editorWidth-25,24);A.strokeStyle="#666";A.lineWidth=1;A.beginPath();A.moveTo(2,document.getElementById("canvas").height-25);A.lineTo(2,document.getElementById("canvas").height-2);A.lineTo(editorWidth-23,document.getElementById("canvas").height-2);A.lineTo(editorWidth-23,document.getElementById("canvas").height-25);A.closePath();A.stroke();A.beginPath();A.moveTo(1,document.getElementById("canvas").height-24);A.lineTo(1,document.getElementById("canvas").height-1);A.lineTo(editorWidth-22,document.getElementById("canvas").height-1);A.lineTo(editorWidth-22,document.getElementById("canvas").height-24);A.closePath();A.strokeStyle="#333";A.stroke();var ap=pageBreaks.length+1;var c="Page "+s+" of "+ap;A.font="10pt sans-serif";A.fillStyle="#000";A.fillText(c,editorWidth-150,document.getElementById("canvas").height-8);var G=["Enter : Action  --  Tab : Character","Enter : Character  --  Tab : Slugline","Enter : Dialog  --  Tab : Action","Enter : Character  --  Tab : Parenthetical","Enter : Dialog  --  Tab : Dialog","Enter : Slugline  --  Tab : Slugline"];A.fillText(G[lines[pos.row][1]],15,document.getElementById("canvas").height-8);var q="Scene "+aq+" of "+scenes.length;A.fillText(q,400,document.getElementById("canvas").height-8);A.font=font;scrollArrows(A);scrollBar(A,R);if(E){pos.row=anch.row;pos.col=anch.col}if(ac){pagination()}if(mouseDownBool&&pos.row<anch.row&&mouseY<40){scroll(-20)}if(mouseDownBool&&pos.row>anch.row&&mouseY>document.getElementById("canvas").height-50){scroll(20)}if(C=="enter"){if(ud>document.getElementById("canvas").height){scroll(600)}}else{if(C){if((2+M+(S*lineheight)-vOffset)>document.getElementById("canvas").height-60){scroll(45)}else{if(ud<45){scroll(-45)}}}}document.getElementById("format").selectedIndex=lines[pos.row][1]}};